<!doctype html>
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="generator" content="Hugo 0.85.0" /><link rel="canonical" type="text/html" href="https://rancher-sandbox.github.io/cOS-toolkit/docs/examples/">
<META NAME="ROBOTS" CONTENT="NOINDEX, NOFOLLOW">


<link rel="shortcut icon" href="https://rancher-sandbox.github.io/cOS-toolkit/favicons/favicon.ico" >
<link rel="apple-touch-icon" href="https://rancher-sandbox.github.io/cOS-toolkit/favicons/apple-touch-icon-180x180.png" sizes="180x180">
<link rel="icon" type="image/png" href="https://rancher-sandbox.github.io/cOS-toolkit/favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="https://rancher-sandbox.github.io/cOS-toolkit/favicons/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="https://rancher-sandbox.github.io/cOS-toolkit/favicons/android-36x36.png" sizes="36x36">
<link rel="icon" type="image/png" href="https://rancher-sandbox.github.io/cOS-toolkit/favicons/android-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="https://rancher-sandbox.github.io/cOS-toolkit/favicons/android-72x72.png" sizes="72x72">
<link rel="icon" type="image/png" href="https://rancher-sandbox.github.io/cOS-toolkit/favicons/android-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="https://rancher-sandbox.github.io/cOS-toolkit/favicons/android-144x144.png" sizes="144x144">
<link rel="icon" type="image/png" href="https://rancher-sandbox.github.io/cOS-toolkit/favicons/android-192x192.png" sizes="192x192">

<title>Examples | cOS toolkit</title>
<meta name="description" content="cOS toolkit documentation website"><meta property="og:title" content="Examples" />
<meta property="og:description" content="Examples and recipes for building cOS derivatives
" />
<meta property="og:type" content="website" />
<meta property="og:url" content="https://rancher-sandbox.github.io/cOS-toolkit/docs/examples/" /><meta property="og:site_name" content="cOS toolkit" />

<meta itemprop="name" content="Examples">
<meta itemprop="description" content="Examples and recipes for building cOS derivatives
"><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Examples"/>
<meta name="twitter:description" content="Examples and recipes for building cOS derivatives
"/>




<link rel="preload" href="https://rancher-sandbox.github.io/cOS-toolkit/scss/main.min.ce822e1833a5405e77f69584ab31fd4bd422643124926787ea63be001e51b0b2.css" as="style">
<link href="https://rancher-sandbox.github.io/cOS-toolkit/scss/main.min.ce822e1833a5405e77f69584ab31fd4bd422643124926787ea63be001e51b0b2.css" rel="stylesheet" integrity="">


<script
  src="https://code.jquery.com/jquery-3.5.1.min.js"
  integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
  crossorigin="anonymous"></script>

<script
  src="https://unpkg.com/lunr@2.3.8/lunr.min.js"
  integrity="sha384-vRQ9bDyE0Wnu+lMfm57BlYLO0/XauFuKpVsZPs7KEDwYKktWi5+Kz3MP8++DFlRY"
  crossorigin="anonymous"></script>



<link rel="stylesheet" href="https://rancher-sandbox.github.io/cOS-toolkit/css/prism.css"/>





<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-00000000-0', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>


  </head>
  <body class="td-section">
    <header>
      
<nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar">
        <a class="navbar-brand" href="https://rancher-sandbox.github.io/cOS-toolkit/">
		<span class="navbar-logo"><svg id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 500 500" style="enable-background:new 0 0 500 500"><g><path style="fill:#fff" d="M116.8525 421.9722c-5.7041.0-10.3442-4.3127-10.3442-9.6129V88.183c0-5.3002 4.6401-9.6117 10.3442-9.6117H320.858c3.0347.0 9.3959.5498 11.7506 2.6302l.3545.3442 58.905 63.2912c2.3101 2.491 2.9202 8.4928 2.9202 11.3184v256.2039c0 5.3002-4.6407 9.6129-10.3436 9.6129H116.8525z"/><g><g><g><path style="fill:#767676" d="M384.4445 423.2066H116.852c-6.3839.0-11.5786-4.8658-11.5786-10.8474V88.1831c0-5.9804 5.1947-10.8461 11.5786-10.8461h204.0062c.377.0 9.2786.0329 12.568 2.9389l.3947.3833 58.9508 63.337c3.2135 3.4652 3.2514 11.7924 3.2514 12.1593v256.2036C396.0231 418.3408 390.8284 423.2066 384.4445 423.2066zM116.5079 411.9189c.0848.0278.1999.0531.3441.0531h267.5925c.1442.0.2581-.0253.3441-.0531V156.1556c-.0076-.9033-.3593-3.7347-.7034-5.0037l-57.6527-61.9416c-1.4651-.3176-4.4533-.6389-5.5742-.6389H116.852c-.143.0-.2594.024-.3441.0531V411.9189zm267.4533-261.149zM327.0321 89.371v.0013V89.371z"/></g></g></g><g><g><path style="fill:#5b7fc0" d="M189.0874 210.1754l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.025 2.454-11.4897 6.4116-15.4473C177.5953 212.627 183.0601 210.1742 189.0874 210.1754zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403S197.0816 234.1722 197.0804 232.033z"/><path style="opacity:.3;fill:#fff" d="M189.0898 210.176c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 212.6276 183.0612 210.176 189.0898 210.176zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 236.239 197.0839 234.2399 197.0839 232.0372z"/><g><defs><path id="SVGID_1_" d="M194.7376 237.6875c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.999 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 234.2399 196.1861 236.239 194.7376 237.6875z"/></defs><clipPath id="SVGID_2_"><use xlink:href="#SVGID_1_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_2_);fill:#fff" d="M190.0704 225.0237c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 225.7247 191.9774 225.0237 190.0704 225.0237z"/><path style="opacity:.13;clip-path:url(#SVGID_2_);fill:#020202" d="M190.0704 225.0237c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 225.7247 191.9774 225.0237 190.0704 225.0237z"/></g><g><defs><path id="SVGID_3_" d="M189.0898 210.176c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 212.6276 183.0612 210.176 189.0898 210.176zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 236.239 197.0839 234.2399 197.0839 232.0372z"/></defs><clipPath id="SVGID_4_"><use xlink:href="#SVGID_3_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_4_);fill:#5b7fc0" d="M172.6595 215.6045c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8612 12.0547.0024 21.8636-9.797 21.8613-21.8612.0024-3.8475-1.0151-7.6326-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 209.1953 176.6171 211.647 172.6595 215.6045z"/></g></g><rect x="198.8952" y="225.1043" style="fill:#5b7fc0" width="122.6266" height="13.8671"/></g><g><path style="fill:#d95140" d="M189.0874 155.7611l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.0249 2.454-11.4897 6.4116-15.4473C177.5953 158.2128 183.0601 155.7599 189.0874 155.7611zm7.993 21.8577c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403C196.2508 181.7667 197.0816 179.758 197.0804 177.6188z"/><path style="opacity:.3;fill:#fff" d="M189.0898 155.7617c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 158.2134 183.0612 155.7617 189.0898 155.7617zm7.9941 21.8613c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 181.8248 197.0839 179.8256 197.0839 177.623z"/><g><defs><path id="SVGID_5_" d="M194.7376 183.2733c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.9989 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 179.8256 196.1861 181.8248 194.7376 183.2733z"/></defs><clipPath id="SVGID_6_"><use xlink:href="#SVGID_5_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_6_);fill:#fff" d="M190.0704 170.6095c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 171.3104 191.9774 170.6095 190.0704 170.6095z"/><path style="opacity:.13;clip-path:url(#SVGID_6_);fill:#020202" d="M190.0704 170.6095c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 171.3104 191.9774 170.6095 190.0704 170.6095z"/></g><g><defs><path id="SVGID_7_" d="M189.0898 155.7617c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 158.2134 183.0612 155.7617 189.0898 155.7617zm7.9941 21.8613c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 181.8248 197.0839 179.8256 197.0839 177.623z"/></defs><clipPath id="SVGID_8_"><use xlink:href="#SVGID_7_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_8_);fill:#d95140" d="M172.6595 161.1903c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8613 12.0547.0024 21.8636-9.797 21.8613-21.8613.0024-3.8474-1.0151-7.6326-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 154.7811 176.6171 157.2327 172.6595 161.1903z"/></g><rect x="198.8952" y="170.69" style="fill:#d95140" width="122.6266" height="13.8671"/></g><g><g><path style="fill:#56a55c" d="M189.5379 264.6147l.0012-.0012c7.7751.0012 15.0294 4.1862 18.932 10.9235 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032-5.8394.0-11.3281-2.2733-15.458-6.4032-4.13-4.13-6.4032-9.6186-6.4056-15.4628.0012-6.0249 2.454-11.4897 6.4116-15.4472C178.0458 267.0663 183.5105 264.6135 189.5379 264.6147zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6538 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403C196.7013 290.6202 197.5321 288.6115 197.5309 286.4723z"/><path style="opacity:.3;fill:#fff" d="M189.5403 264.6153c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8065-21.8612-21.8613.0-6.0285 2.4516-11.492 6.4116-15.452C178.0482 267.0669 183.5117 264.6153 189.5403 264.6153zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.6366 290.6783 197.5344 288.6792 197.5344 286.4765z"/><g><defs><path id="SVGID_9_" d="M195.1881 292.1268c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.9989 7.9942-7.9941 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.5344 288.6792 196.6366 290.6783 195.1881 292.1268z"/></defs><clipPath id="SVGID_10_"><use xlink:href="#SVGID_9_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_10_);fill:#fff" d="M190.5209 279.463c-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7446-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9941 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C194.239 280.164 192.4279 279.463 190.5209 279.463z"/><path style="opacity:.13;clip-path:url(#SVGID_10_);fill:#020202" d="M190.5209 279.463c-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7446-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9941 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C194.239 280.164 192.4279 279.463 190.5209 279.463z"/></g><g><defs><path id="SVGID_11_" d="M189.5403 264.6153c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8065-21.8612-21.8613.0-6.0285 2.4516-11.492 6.4116-15.452C178.0482 267.0669 183.5117 264.6153 189.5403 264.6153zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.6366 290.6783 197.5344 288.6792 197.5344 286.4765z"/></defs><clipPath id="SVGID_12_"><use xlink:href="#SVGID_11_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_12_);fill:#56a55c" d="M173.11 270.0439c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8613 12.0547.0024 21.8636-9.797 21.8613-21.8613.0024-3.8474-1.0151-7.6326-2.9353-10.9462-3.8977-6.7325-11.1497-10.9151-18.926-10.9151C182.5311 263.6346 177.0676 266.0863 173.11 270.0439z"/></g></g><rect x="199.3456" y="279.5436" style="fill:#56a55c" width="122.6266" height="13.8671"/></g><g><g><path style="fill:#f1bc42" d="M189.0874 318.7208l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3305-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.025 2.454-11.4897 6.4116-15.4472C177.5953 321.1724 183.0601 318.7196 189.0874 318.7208zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403S197.0816 342.7176 197.0804 340.5784z"/><path style="opacity:.3;fill:#fff" d="M189.0898 318.7214c7.7763.0 15.0283 4.1826 18.926 10.915 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8612-12.0547.0024-21.8636-9.8065-21.8612-21.8612.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 321.173 183.0612 318.7214 189.0898 318.7214zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 344.7844 197.0839 342.7853 197.0839 340.5826z"/><g><defs><path id="SVGID_13_" d="M194.7376 346.2329c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.999 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 342.7853 196.1861 344.7844 194.7376 346.2329z"/></defs><clipPath id="SVGID_14_"><use xlink:href="#SVGID_13_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_14_);fill:#fff" d="M190.0704 333.5691c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0834 6.1218 2.8788C193.7885 334.2701 191.9774 333.5691 190.0704 333.5691z"/><path style="opacity:.13;clip-path:url(#SVGID_14_);fill:#020202" d="M190.0704 333.5691c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0834 6.1218 2.8788C193.7885 334.2701 191.9774 333.5691 190.0704 333.5691z"/></g><g><defs><path id="SVGID_15_" d="M189.0898 318.7214c7.7763.0 15.0283 4.1826 18.926 10.915 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8612-12.0547.0024-21.8636-9.8065-21.8612-21.8612.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 321.173 183.0612 318.7214 189.0898 318.7214zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 344.7844 197.0839 342.7853 197.0839 340.5826z"/></defs><clipPath id="SVGID_16_"><use xlink:href="#SVGID_15_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_16_);fill:#f1bc42" d="M172.6595 324.15c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8612 12.0547.0024 21.8636-9.797 21.8613-21.8612.0024-3.8474-1.0151-7.6327-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 317.7407 176.6171 320.1924 172.6595 324.15z"/></g></g><rect x="198.8952" y="333.6497" style="fill:#f1bc42" width="122.6266" height="13.8671"/></g></g></svg></span><span class="text-uppercase font-weight-bold">cOS toolkit</span>
	</a>
	<div class="td-navbar-nav-scroll ml-md-auto" id="main_navbar">
		<ul class="navbar-nav mt-2 mt-lg-0">
			
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				
				
				<a class="nav-link active" href="https://rancher-sandbox.github.io/cOS-toolkit/docs/" ><span class="active">Documentation</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				<a class="nav-link" href="https://github.com/rancher-sandbox/cOS-toolkit/releases" target="_blank" ><i class='fab fa-github'></i><span>Github releases</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				<a class="nav-link" href="https://rancher-sandbox.github.io/cos-toolkit-package-browser/" target="_blank" ><i class='fa fa-toolbox'></i><span>Browse packages</span></a>
			</li>
			
			
			
		</ul>
	</div>
	<div class="navbar-nav d-none d-lg-block">



<input
  type="search"
  class="form-control td-search-input"
  placeholder="&#xf002; Search this site…"
  aria-label="Search this site…"
  autocomplete="off"
  
  data-offline-search-index-json-src="https://rancher-sandbox.github.io/cOS-toolkit/offline-search-index.be553f1cb919c34ffbac66d0dc644fc3.json"
  data-offline-search-base-href="https://rancher-sandbox.github.io/cOS-toolkit/"
  data-offline-search-max-results="10"
>

</div>
</nav>

    </header>
    <div class="container-fluid td-outer">
      <div class="td-main">
        <div class="row flex-xl-nowrap">
          <div class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none">
          </div>
          <div class="d-none d-xl-block col-xl-2 td-toc d-print-none">
          </div>
          <main class="col-12 col-md-9 col-xl-8 pl-md-5" role="main">
            




<div class="td-content">
<div class="pageinfo pageinfo-primary d-print-none">
<p>
This the multi-page printable view of this section.
<a href="#" onclick="print();return false;">Click here to print</a>.
</p><p>
<a href="https://rancher-sandbox.github.io/cOS-toolkit/docs/examples/">Return to the regular view of this page</a>.
</p>
</div>



<h1 class="title">Examples</h1>
<div class="lead">Examples and recipes for building cOS derivatives</div>




    <ul>
    
  
  
  
  

  
    
    
	
<li>1: <a href="#pg-69286228d8129cf393e95a7cae077086">Creating bootable images</a></li>


    
  
    
    
	
<li>2: <a href="#pg-87fa66e8f5fb02335e3eb5b85600fc0f">Creating embedded images</a></li>


    
  

    </ul>


<div class="content">
      
</div>
</div>


  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-69286228d8129cf393e95a7cae077086">1 - Creating bootable images</h1>
    <div class="lead">This document describes the requirements to create standard container images that can be used for <code>cOS</code> deployments</div>
	<p>You can find the examples below in the <a href="https://github.com/rancher-sandbox/cOS-toolkit/tree/master/examples">examples</a> folder.</p>
<h2 id="from-standard-images">From standard images</h2>
<p>Besides using the <code>cos-toolkit</code> toolchain, it&rsquo;s possible to create standard container images which are consumable by the vanilla <code>cOS</code> images (ISO, Cloud Images, etc.) during the upgrade and deploy phase.</p>
<p>An example of a Dockerfile image can be:</p>





<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Dockerfile" data-lang="Dockerfile"><span style="color:#204a87;font-weight:bold">ARG</span> <span style="color:#000">LUET_VERSION</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">0</span>.20.6<span style="color:#a40000">
</span><span style="color:#a40000"></span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#4e9a06"> quay.io/luet/base:$LUET_VERSION AS luet</span><span style="color:#a40000">
</span><span style="color:#a40000">
</span><span style="color:#a40000"></span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#4e9a06"> opensuse/leap:15.3</span><span style="color:#a40000">
</span><span style="color:#a40000">
</span><span style="color:#a40000"></span><span style="color:#204a87;font-weight:bold">ENV</span> <span style="color:#000">COSIGN_EXPERIMENTAL</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">1</span>
<span style="color:#204a87;font-weight:bold">ENV</span> <span style="color:#000">COSIGN_REPOSITORY</span><span style="color:#ce5c00;font-weight:bold">=</span>raccos/releases-green<span style="color:#a40000">
</span><span style="color:#a40000">
</span><span style="color:#a40000"></span><span style="color:#204a87;font-weight:bold">ARG</span> <span style="color:#000">ARCH</span><span style="color:#ce5c00;font-weight:bold">=</span>amd64
<span style="color:#204a87;font-weight:bold">ENV</span> <span style="color:#000">ARCH</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">${</span><span style="color:#000">ARCH</span><span style="color:#4e9a06">}</span><span style="color:#a40000">
</span><span style="color:#a40000"></span><span style="color:#204a87;font-weight:bold">RUN</span> zypper in -y <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>    bash-completion <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>    conntrack-tools <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>    coreutils <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>    curl <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>    device-mapper <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>    dosfstools <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>    dracut <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>    e2fsprogs <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>    findutils <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>    gawk <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>    gptfdisk <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>    grub2-i386-pc <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>    grub2-x86_64-efi <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>    haveged <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>    iproute2 <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>    iptables <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>    iputils <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>    issue-generator <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>    jq <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>    kernel-default <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>    kernel-firmware-bnx2 <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>    kernel-firmware-i915 <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>    kernel-firmware-intel <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>    kernel-firmware-iwlwifi <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>    kernel-firmware-mellanox <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>    kernel-firmware-network <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>    kernel-firmware-platform <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>    kernel-firmware-realtek <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>    less <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>    lsscsi <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>    lvm2 <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>    mdadm <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>    multipath-tools <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>    nano <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>    NetworkManager<span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>    nfs-utils <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>    open-iscsi <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>    open-vm-tools <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>    parted <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>    pigz <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>    policycoreutils <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>    procps <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>    python-azure-agent <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>    qemu-guest-agent <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>    rng-tools <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>    rsync <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>    squashfs <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>    strace <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>    systemd <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>    systemd-sysvinit <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>    tar <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>    timezone <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>    vim <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>    which<span style="color:#a40000">
</span><span style="color:#a40000">
</span><span style="color:#a40000"></span><span style="color:#204a87;font-weight:bold">RUN</span> zypper cc<span style="color:#a40000">
</span><span style="color:#a40000">
</span><span style="color:#a40000"></span><span style="color:#8f5902;font-style:italic"># Configure NetworkManager as default network management service</span><span style="color:#a40000">
</span><span style="color:#a40000"></span><span style="color:#204a87;font-weight:bold">RUN</span> zypper remove -y wicked<span style="color:#a40000">
</span><span style="color:#a40000"></span><span style="color:#204a87;font-weight:bold">RUN</span> systemctl disable wicked <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>    <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> systemctl <span style="color:#204a87">enable</span> NetworkManager<span style="color:#a40000">
</span><span style="color:#a40000">
</span><span style="color:#a40000"></span><span style="color:#8f5902;font-style:italic"># Copy the luet config file pointing to the upgrade repository</span><span style="color:#a40000">
</span><span style="color:#a40000"></span><span style="color:#204a87;font-weight:bold">COPY</span> conf/luet.yaml /etc/luet/luet.yaml<span style="color:#a40000">
</span><span style="color:#a40000">
</span><span style="color:#a40000"></span><span style="color:#8f5902;font-style:italic"># Copy luet from the official images</span><span style="color:#a40000">
</span><span style="color:#a40000"></span><span style="color:#204a87;font-weight:bold">COPY</span> --from<span style="color:#ce5c00;font-weight:bold">=</span>luet /usr/bin/luet /usr/bin/luet<span style="color:#a40000">
</span><span style="color:#a40000">
</span><span style="color:#a40000"></span><span style="color:#204a87;font-weight:bold">RUN</span> luet install -y meta/cos-verify<span style="color:#a40000">
</span><span style="color:#a40000">
</span><span style="color:#a40000"></span><span style="color:#204a87;font-weight:bold">RUN</span> luet install --plugin luet-cosign -y meta/cos-minimal <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>    utils/k9s <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>    utils/nerdctl<span style="color:#a40000">
</span><span style="color:#a40000">
</span><span style="color:#a40000"></span><span style="color:#204a87;font-weight:bold">COPY</span> files/ /<span style="color:#a40000">
</span><span style="color:#a40000"></span><span style="color:#204a87;font-weight:bold">RUN</span> mkinitrd<span style="color:#a40000">
</span></code></pre></div>

<small> <i class='fab fa-github'></i> <i>Complete source code:  <a target=_blank href="https://github.com/rancher-sandbox/cos-toolkit/blob/master/examples/standard/Dockerfile">https://github.com/rancher-sandbox/cos-toolkit/blob/master/examples/standard/Dockerfile</a></i> </small>
<hr>

<p>While the config file:</p>





<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#204a87;font-weight:bold">logging</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">color</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">false</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">enable_emoji</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">false</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">general</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#204a87;font-weight:bold">debug</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">false</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#204a87;font-weight:bold">spinner_charset</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">9</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">repositories</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;cos&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">description</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;cOS official&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">type</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;docker&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">enable</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">cached</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">priority</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">verify</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">false</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">urls</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#4e9a06">&#34;quay.io/costoolkit/releases-green&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></code></pre></div>

<small> <i class='fab fa-github'></i> <i>Complete source code:  <a target=_blank href="https://github.com/rancher-sandbox/cos-toolkit/blob/master/examples/standard/conf/luet.yaml">https://github.com/rancher-sandbox/cos-toolkit/blob/master/examples/standard/conf/luet.yaml</a></i> </small>
<hr>

<p>We can just run docker to build the image with</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">docker build -t <span style="color:#000">$IMAGE</span> .
</code></pre></div><p>The important piece is that an image needs to ship at least:</p>
<pre><code>toolchain/yip
utils/installer
system/cos-setup
system/immutable-rootfs
system/grub2-config
</code></pre><p>from the toolchain. If you want to customize further the container further add more step afterwards <code>luet install</code> see <a href="../../customizing">the customizing section</a>.</p>


<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Note</h4>

    Depending on the base image (<code>FROM opensuse/leap:15.3</code> in the sample), you must set the corresponding repository for each flavor <a href="../../getting-started/download#releases">see releases</a> in the luet config file ( which in the sample above points to the <em>green</em> releases )

</div>

<h2 id="generating-from-ci-image">Generating from CI image</h2>
<p>Derivatives can be stacked on top of another, so it is possible to reuse directly also the vanilla cOS images:</p>





<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Dockerfile" data-lang="Dockerfile"><span style="color:#8f5902;font-style:italic"># Pick one version from https://quay.io/repository/costoolkit/releases-green?tab=tags</span><span style="color:#a40000">
</span><span style="color:#a40000"></span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#4e9a06"> quay.io/costoolkit/releases-green:cos-system-0.5.8-4</span><span style="color:#a40000">
</span><span style="color:#a40000">
</span><span style="color:#a40000"></span><span style="color:#204a87;font-weight:bold">COPY</span> files/ /<span style="color:#a40000">
</span></code></pre></div>

<small> <i class='fab fa-github'></i> <i>Complete source code:  <a target=_blank href="https://github.com/rancher-sandbox/cos-toolkit/blob/master/examples/cos-official/Dockerfile">https://github.com/rancher-sandbox/cos-toolkit/blob/master/examples/cos-official/Dockerfile</a></i> </small>
<hr>

<p>The images contains already the toolkit, so they can be used as-is and apply further customization on top.</p>
<h2 id="from-scratch">From scratch</h2>
<p>The luet image <code>quay.io/luet/base</code> contains just luet, and can be used to boostrap the base system from scratch:</p>
<p>conf/luet.yaml:





<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#204a87;font-weight:bold">logging</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">color</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">false</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">enable_emoji</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">false</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">general</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#204a87;font-weight:bold">debug</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">false</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#204a87;font-weight:bold">spinner_charset</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">9</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">repositories</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;cos&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">description</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;cOS official&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">type</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;docker&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">enable</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">cached</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">priority</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">verify</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">false</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">urls</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#4e9a06">&#34;quay.io/costoolkit/releases-green&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></code></pre></div>

<small> <i class='fab fa-github'></i> <i>Complete source code:  <a target=_blank href="https://github.com/rancher-sandbox/cos-toolkit/blob/master/examples/scratch/conf/luet.yaml">https://github.com/rancher-sandbox/cos-toolkit/blob/master/examples/scratch/conf/luet.yaml</a></i> </small>
<hr>
</p>
<p>Dockerfile:





<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Dockerfile" data-lang="Dockerfile"><span style="color:#204a87;font-weight:bold">ARG</span> <span style="color:#000">LUET_VERSION</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">0</span>.20.6<span style="color:#a40000">
</span><span style="color:#a40000">
</span><span style="color:#a40000"></span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#4e9a06"> quay.io/luet/base:$LUET_VERSION AS luet</span><span style="color:#a40000">
</span><span style="color:#a40000">
</span><span style="color:#a40000"></span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#4e9a06"> opensuse/leap:15.3 AS ca</span><span style="color:#a40000">
</span><span style="color:#a40000">
</span><span style="color:#a40000"></span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#4e9a06"> scratch</span><span style="color:#a40000">
</span><span style="color:#a40000">
</span><span style="color:#a40000"></span><span style="color:#8f5902;font-style:italic"># Copy luet from the official images</span><span style="color:#a40000">
</span><span style="color:#a40000"></span><span style="color:#204a87;font-weight:bold">COPY</span> --from<span style="color:#ce5c00;font-weight:bold">=</span>luet /usr/bin/luet /usr/bin/luet<span style="color:#a40000">
</span><span style="color:#a40000"></span><span style="color:#204a87;font-weight:bold">COPY</span> --from<span style="color:#ce5c00;font-weight:bold">=</span>ca /etc/ssl/certs/. /etc/ssl/certs/<span style="color:#a40000">
</span><span style="color:#a40000">
</span><span style="color:#a40000"></span><span style="color:#8f5902;font-style:italic"># Copy the luet config file pointing to the cOS repository</span><span style="color:#a40000">
</span><span style="color:#a40000"></span><span style="color:#204a87;font-weight:bold">ADD</span> conf/luet.yaml /etc/luet/luet.yaml<span style="color:#a40000">
</span><span style="color:#a40000"></span><span style="color:#204a87;font-weight:bold">ENV</span> <span style="color:#000">USER</span><span style="color:#ce5c00;font-weight:bold">=</span>root
<span style="color:#204a87;font-weight:bold">ENV</span> <span style="color:#000">LUET_NOLOCK</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87">true</span>
<span style="color:#204a87;font-weight:bold">SHELL</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;/usr/bin/luet&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;install&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;-y&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;-d&#34;</span><span style="color:#000;font-weight:bold">]</span><span style="color:#a40000">
</span><span style="color:#a40000">
</span><span style="color:#a40000"></span><span style="color:#204a87;font-weight:bold">RUN</span> system/cos-container<span style="color:#a40000">
</span><span style="color:#a40000">
</span><span style="color:#a40000"></span><span style="color:#204a87;font-weight:bold">SHELL</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;/bin/sh&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;-c&#34;</span><span style="color:#000;font-weight:bold">]</span><span style="color:#a40000">
</span><span style="color:#a40000"></span><span style="color:#204a87;font-weight:bold">RUN</span> rm -rf /var/cache/luet/packages/ /var/cache/luet/repos/<span style="color:#a40000">
</span><span style="color:#a40000">
</span><span style="color:#a40000"></span><span style="color:#204a87;font-weight:bold">ENV</span> <span style="color:#000">TMPDIR</span><span style="color:#ce5c00;font-weight:bold">=</span>/tmp<span style="color:#a40000">
</span><span style="color:#a40000"></span><span style="color:#204a87;font-weight:bold">ENTRYPOINT</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;/bin/sh&#34;</span><span style="color:#000;font-weight:bold">]</span></code></pre></div>

<small> <i class='fab fa-github'></i> <i>Complete source code:  <a target=_blank href="https://github.com/rancher-sandbox/cos-toolkit/blob/master/examples/scratch/Dockerfile">https://github.com/rancher-sandbox/cos-toolkit/blob/master/examples/scratch/Dockerfile</a></i> </small>
<hr>
</p>
<h2 id="customizations">Customizations</h2>
<p>All the method above imply that the image generated will be the booting one, there are however several configuration entrypoint that you should keep in mind while building the image:</p>
<ul>
<li>Everything under <code>/system/oem</code> will be loaded during the various stage (boot, network, initramfs). You can check <a href="https://github.com/rancher-sandbox/cOS-toolkit/tree/e411d8b3f0044edffc6fafa39f3097b471ef46bc/packages/cloud-config/oem">here</a> for the <code>cOS</code> defaults. See <code>00_rootfs.yaml</code> to customize the booting layout.</li>
<li><code>/etc/cos/bootargs.cfg</code> contains the booting options required to boot the image with GRUB</li>
<li><code>/etc/cos-upgrade-image</code> contains the default upgrade configuration for recovery and the booting system image</li>
</ul>
<h2 id="configuration-file">Configuration file</h2>
<p>The example configuration file shows how to enable the cos-toolkit repository:</p>





<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#204a87;font-weight:bold">logging</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">color</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">false</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">enable_emoji</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">false</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">general</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#204a87;font-weight:bold">debug</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">false</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#204a87;font-weight:bold">spinner_charset</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">9</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">repositories</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;cos&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">description</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;cOS official&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">type</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;docker&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">enable</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">cached</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">priority</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">verify</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">false</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">urls</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#4e9a06">&#34;quay.io/costoolkit/releases-green&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></code></pre></div>

<small> <i class='fab fa-github'></i> <i>Complete source code:  <a target=_blank href="https://github.com/rancher-sandbox/cos-toolkit/blob/master/examples/standard/conf/luet.yaml">https://github.com/rancher-sandbox/cos-toolkit/blob/master/examples/standard/conf/luet.yaml</a></i> </small>
<hr>

<p>Repositories have the following fields, notably:</p>
<ul>
<li><code>name</code>: Repository name</li>
<li><code>enable</code>: Enable/disables the repository</li>
<li><code>arch</code>:  (optional) Denotes the arch repository. If present, it will enable the repository automatically if the corresponding arch is matching with the host running <code>luet</code>. <code>enable: true</code> would override this behavior</li>
<li><code>reference</code>: (optional) A reference to a repository index file to use to retrieve the repository metadata instead of latest. This can be used to point to a different or an older repository index to act as a &ldquo;wayback machine&rdquo;. The client will consume the repository state from that snapshot instead of latest.</li>
</ul>


<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Note</h4>

    The <code>reference</code> field has to be a valid tag. For example, for the <code>green</code> flavor, browse the relevant <a href="https://quay.io/repository/costoolkit/releases-green?tab=tags">container image list page</a>. The repository index snapshots are prefixed with a timestamp, and ending in <code>repository.yaml</code>. For example <code> 20211027153653-repository.yaml</code>

</div>


</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-87fa66e8f5fb02335e3eb5b85600fc0f">2 - Creating embedded images</h1>
    <div class="lead">This document is a step-by-step guide to build a customized embedded system that can be used in cOS</div>
	<p>This guide will guide in a step-by-step process to build a derivative which is fully compatible with cOS, and will illustrate how to make customization on such image, by adding for example a default set of services and a custom user.</p>
<p>The derivative will be based on openSUSE and embed k3s, and a custom user <code>joe</code> which will be already set to allow us to login.</p>
<h2 id="prerequisites">Prerequisites</h2>
<ul>
<li>Docker installed</li>
</ul>
<h2 id="1-create-a-dockerfile">1) Create a Dockerfile</h2>
<p>Let&rsquo;s create a workspace directory and move into it:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$&gt; mkdir derivative
$&gt; <span style="color:#204a87">cd</span> derivative
</code></pre></div><p>Let&rsquo;s create now a <code>Dockerfile</code> for our image inside that directory, which will be represent running system:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Dockerfile" data-lang="Dockerfile"><span style="color:#8f5902;font-style:italic"># Let&#39;s copy over luet from official images. </span><span style="color:#a40000">
</span><span style="color:#a40000"></span><span style="color:#8f5902;font-style:italic"># This version will be used to bootstrap luet itself and cOS internal components</span><span style="color:#a40000">
</span><span style="color:#a40000"></span><span style="color:#204a87;font-weight:bold">ARG</span> <span style="color:#000">LUET_VERSION</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">0</span>.16.7<span style="color:#a40000">
</span><span style="color:#a40000"></span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#4e9a06"> quay.io/luet/base:$LUET_VERSION AS luet</span><span style="color:#a40000">
</span><span style="color:#a40000">
</span><span style="color:#a40000"></span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#4e9a06"> opensuse/leap:15.3</span><span style="color:#a40000">
</span><span style="color:#a40000"></span><span style="color:#204a87;font-weight:bold">ARG</span> <span style="color:#000">K3S_VERSION</span><span style="color:#ce5c00;font-weight:bold">=</span>v1.20.4+k3s1<span style="color:#a40000">
</span><span style="color:#a40000"></span><span style="color:#204a87;font-weight:bold">ARG</span> <span style="color:#000">ARCH</span><span style="color:#ce5c00;font-weight:bold">=</span>amd64
<span style="color:#204a87;font-weight:bold">ENV</span> <span style="color:#000">ARCH</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">${</span><span style="color:#000">ARCH</span><span style="color:#4e9a06">}</span><span style="color:#a40000">
</span><span style="color:#a40000">
</span><span style="color:#a40000"></span><span style="color:#8f5902;font-style:italic"># Install packages from the base image</span><span style="color:#a40000">
</span><span style="color:#a40000"></span><span style="color:#204a87;font-weight:bold">RUN</span> zypper in -y <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>    bash-completion <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>    conntrack-tools <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>    coreutils <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>    curl <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>    device-mapper <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>    dosfstools <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>    dracut <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>    e2fsprogs <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>    findutils <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>    gawk <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>    gptfdisk <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>    grub2-i386-pc <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>    grub2-x86_64-efi <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>    haveged <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>    iproute2 <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>    iptables <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>    iputils <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>    issue-generator <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>    jq <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>    kernel-default <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>    kernel-firmware-bnx2 <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>    kernel-firmware-i915 <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>    kernel-firmware-intel <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>    kernel-firmware-iwlwifi <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>    kernel-firmware-mellanox <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>    kernel-firmware-network <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>    kernel-firmware-platform <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>    kernel-firmware-realtek <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>    less <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>    lsscsi <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>    lvm2 <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>    mdadm <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>    multipath-tools <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>    nano <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>    nfs-utils <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>    open-iscsi <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>    open-vm-tools <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>    parted <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>    pigz <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>    policycoreutils <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>    procps <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>    python-azure-agent <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>    qemu-guest-agent <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>    rng-tools <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>    rsync <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>    squashfs <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>    strace <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>    systemd <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>    systemd-sysvinit <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>    tar <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>    timezone <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>    vim <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>    which<span style="color:#a40000">
</span><span style="color:#a40000">
</span><span style="color:#a40000"></span><span style="color:#8f5902;font-style:italic"># Copy the luet config file pointing to the upgrade repository</span><span style="color:#a40000">
</span><span style="color:#a40000"></span><span style="color:#204a87;font-weight:bold">COPY</span> repositories.yaml /etc/luet/luet.yaml<span style="color:#a40000">
</span><span style="color:#a40000">
</span><span style="color:#a40000"></span><span style="color:#8f5902;font-style:italic"># Copy luet from the official images</span><span style="color:#a40000">
</span><span style="color:#a40000"></span><span style="color:#204a87;font-weight:bold">COPY</span> --from<span style="color:#ce5c00;font-weight:bold">=</span>luet /usr/bin/luet /usr/bin/luet<span style="color:#a40000">
</span><span style="color:#a40000"></span><span style="color:#204a87;font-weight:bold">RUN</span> luet install -y <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>       toolchain/yip <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>       toolchain/luet <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>       utils/installer <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>       system/cos-setup <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>       system/immutable-rootfs <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>       system/grub2-config <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>       system/base-dracut-modules<span style="color:#a40000">
</span><span style="color:#a40000">
</span><span style="color:#a40000"></span><span style="color:#8f5902;font-style:italic"># Install k3s server/agent</span><span style="color:#a40000">
</span><span style="color:#a40000"></span><span style="color:#204a87;font-weight:bold">ENV</span> <span style="color:#000">INSTALL_K3S_VERSION</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">${</span><span style="color:#000">K3S_VERSION</span><span style="color:#4e9a06">}</span><span style="color:#a40000">
</span><span style="color:#a40000"></span><span style="color:#204a87;font-weight:bold">RUN</span> curl -sfL https://get.k3s.io &gt; installer.sh <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>    <span style="color:#000">INSTALL_K3S_SKIP_START</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;true&#34;</span> <span style="color:#000">INSTALL_K3S_SKIP_ENABLE</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;true&#34;</span> sh installer.sh <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>    <span style="color:#000">INSTALL_K3S_SKIP_START</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;true&#34;</span> <span style="color:#000">INSTALL_K3S_SKIP_ENABLE</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;true&#34;</span> sh installer.sh agent <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>    rm -rf installer.sh<span style="color:#a40000">
</span><span style="color:#a40000">
</span><span style="color:#a40000"></span><span style="color:#8f5902;font-style:italic">## System layout</span><span style="color:#a40000">
</span><span style="color:#a40000">
</span><span style="color:#a40000"></span><span style="color:#8f5902;font-style:italic"># Required by k3s etc.</span><span style="color:#a40000">
</span><span style="color:#a40000"></span><span style="color:#204a87;font-weight:bold">RUN</span> mkdir /usr/libexec <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> touch /usr/libexec/.keep<span style="color:#a40000">
</span><span style="color:#a40000">
</span><span style="color:#a40000"></span><span style="color:#8f5902;font-style:italic"># Copy custom files</span><span style="color:#a40000">
</span><span style="color:#a40000"></span><span style="color:#8f5902;font-style:italic"># COPY files/ /</span><span style="color:#a40000">
</span><span style="color:#a40000">
</span><span style="color:#a40000"></span><span style="color:#8f5902;font-style:italic"># Copy cloud-init default configuration</span><span style="color:#a40000">
</span><span style="color:#a40000"></span><span style="color:#204a87;font-weight:bold">COPY</span> cloud-init.yaml /system/oem/<span style="color:#a40000">
</span><span style="color:#a40000">
</span><span style="color:#a40000"></span><span style="color:#8f5902;font-style:italic"># Generate initrd</span><span style="color:#a40000">
</span><span style="color:#a40000"></span><span style="color:#204a87;font-weight:bold">RUN</span> mkinitrd<span style="color:#a40000">
</span><span style="color:#a40000">
</span><span style="color:#a40000"></span><span style="color:#8f5902;font-style:italic"># OS level configuration</span><span style="color:#a40000">
</span><span style="color:#a40000"></span><span style="color:#204a87;font-weight:bold">RUN</span> <span style="color:#204a87">echo</span> <span style="color:#4e9a06">&#34;VERSION=999&#34;</span> &gt; /etc/os-release<span style="color:#a40000">
</span><span style="color:#a40000"></span><span style="color:#204a87;font-weight:bold">RUN</span> <span style="color:#204a87">echo</span> <span style="color:#4e9a06">&#34;GRUB_ENTRY_NAME=derivative&#34;</span> &gt;&gt; /etc/os-release<span style="color:#a40000">
</span><span style="color:#a40000"></span><span style="color:#204a87;font-weight:bold">RUN</span> <span style="color:#204a87">echo</span> <span style="color:#4e9a06">&#34;welcome to our derivative&#34;</span> &gt;&gt; /etc/issue.d/01-derivative<span style="color:#a40000">
</span><span style="color:#a40000">
</span><span style="color:#a40000"></span><span style="color:#8f5902;font-style:italic"># Copy cloud-init default configuration</span><span style="color:#a40000">
</span><span style="color:#a40000"></span><span style="color:#204a87;font-weight:bold">COPY</span> cloud-init.yaml /system/oem/<span style="color:#a40000">
</span></code></pre></div><p>Create then <code>repositories.yaml</code> in <code>derivative/repositories.yaml</code> with the following content:</p>





<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#204a87;font-weight:bold">logging</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">color</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">false</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">enable_emoji</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">false</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">general</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#204a87;font-weight:bold">debug</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">false</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#204a87;font-weight:bold">spinner_charset</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">9</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">repositories</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;cos&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">description</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;cOS official&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">type</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;docker&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">enable</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">cached</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">priority</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">verify</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">false</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">urls</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#4e9a06">&#34;quay.io/costoolkit/releases-green&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></code></pre></div>

<small> <i class='fab fa-github'></i> <i>Complete source code:  <a target=_blank href="https://github.com/rancher-sandbox/cos-toolkit/blob/master/examples/standard/conf/luet.yaml">https://github.com/rancher-sandbox/cos-toolkit/blob/master/examples/standard/conf/luet.yaml</a></i> </small>
<hr>

<h2 id="2-configuration">2) Configuration</h2>
<p>At the end of the Dockerfile, you can see that we copy over a custom <a href="../../reference/cloud_init">cloud-init</a> file:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Dockerfile" data-lang="Dockerfile"><span style="color:#8f5902;font-style:italic"># Copy cloud-init default configuration</span><span style="color:#a40000">
</span><span style="color:#a40000"></span><span style="color:#204a87;font-weight:bold">COPY</span> cloud-init.yaml /system/oem/<span style="color:#a40000">
</span></code></pre></div><p>Create a <code>cloud-init.yaml</code> file as the <code>derivative/cloud-init.yaml</code> with the following content:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#8f5902;font-style:italic"># See https://rancher-sandbox.github.io/cOS-toolkit/docs/reference/cloud_init/ for a full syntax reference</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;Default settings&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">stages</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#204a87;font-weight:bold">initramfs</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">     </span><span style="color:#8f5902;font-style:italic"># Setup default hostname</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">     </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;Branding&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#204a87;font-weight:bold">hostname</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;derivative&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">     </span><span style="color:#8f5902;font-style:italic"># Setup an admin group with sudo access</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">     </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;Setup groups&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#204a87;font-weight:bold">ensure_entities</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">       </span>- <span style="color:#204a87;font-weight:bold">entity</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">|</span><span style="color:#8f5902;font-style:italic">
</span><span style="color:#8f5902;font-style:italic">            kind: &#34;group&#34;
</span><span style="color:#8f5902;font-style:italic">            group_name: &#34;admin&#34;
</span><span style="color:#8f5902;font-style:italic">            password: &#34;x&#34;
</span><span style="color:#8f5902;font-style:italic">            gid: 900</span><span style="color:#f8f8f8;text-decoration:underline">            
</span><span style="color:#f8f8f8;text-decoration:underline">     </span><span style="color:#8f5902;font-style:italic"># Setup network - openSUSE specific</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">     </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;Network setup&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#204a87;font-weight:bold">files</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">       </span>- <span style="color:#204a87;font-weight:bold">path</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">/etc/sysconfig/network/ifcfg-eth0</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#204a87;font-weight:bold">content</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">|</span><span style="color:#8f5902;font-style:italic">
</span><span style="color:#8f5902;font-style:italic">                  BOOTPROTO=&#39;dhcp&#39;
</span><span style="color:#8f5902;font-style:italic">                  STARTMODE=&#39;onboot&#39;</span><span style="color:#f8f8f8;text-decoration:underline">                  
</span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#204a87;font-weight:bold">permissions</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0600</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#204a87;font-weight:bold">owner</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#204a87;font-weight:bold">group</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">     </span><span style="color:#8f5902;font-style:italic"># Setup a custom user</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">     </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;Setup users&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#204a87;font-weight:bold">users</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#8f5902;font-style:italic"># Replace the default user name here and settings</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">joe</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#8f5902;font-style:italic"># Comment passwd for no password</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">passwd</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;joe&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">shell</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">/bin/bash</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">homedir</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;/home/joe&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">groups</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">          </span>- <span style="color:#4e9a06">&#34;admin&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#8f5902;font-style:italic">#authorized_keys:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#8f5902;font-style:italic"># Replace here with your ssh keys</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#8f5902;font-style:italic"># joe: </span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#8f5902;font-style:italic"># - ssh-rsa ....</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">     </span><span style="color:#8f5902;font-style:italic"># Setup sudo</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">     </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;Setup sudo&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#204a87;font-weight:bold">files</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">       </span>- <span style="color:#204a87;font-weight:bold">path</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;/etc/sudoers&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#204a87;font-weight:bold">owner</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#204a87;font-weight:bold">group</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#204a87;font-weight:bold">permsisions</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0600</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#204a87;font-weight:bold">content</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">|</span><span style="color:#8f5902;font-style:italic">
</span><span style="color:#8f5902;font-style:italic">            Defaults always_set_home
</span><span style="color:#8f5902;font-style:italic">            Defaults secure_path=&#34;/usr/sbin:/usr/bin:/sbin:/bin:/usr/local/bin:/usr/local/sbin&#34;
</span><span style="color:#8f5902;font-style:italic">            Defaults env_reset
</span><span style="color:#8f5902;font-style:italic">            Defaults env_keep = &#34;LANG LC_ADDRESS LC_CTYPE LC_COLLATE LC_IDENTIFICATION LC_MEASUREMENT LC_MESSAGES LC_MONETARY LC_NAME LC_NUMERIC LC_PAPER LC_TELEPHONE LC_ATIME LC_ALL LANGUAGE LINGUAS XDG_SESSION_COOKIE&#34;
</span><span style="color:#8f5902;font-style:italic">            Defaults !insults
</span><span style="color:#8f5902;font-style:italic">            root ALL=(ALL) ALL
</span><span style="color:#8f5902;font-style:italic">            %admin ALL=(ALL) NOPASSWD: ALL
</span><span style="color:#8f5902;font-style:italic">            @includedir /etc/sudoers.d</span><span style="color:#f8f8f8;text-decoration:underline">            
</span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#204a87;font-weight:bold">commands</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">       </span>- <span style="color:#000">passwd -l root</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#8f5902;font-style:italic"># Setup persistency so k3s works properly</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#8f5902;font-style:italic"># See also: https://rancher-sandbox.github.io/cOS-toolkit/docs/reference/immutable_rootfs/#configuration-with-an-environment-file</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#204a87;font-weight:bold">rootfs.after</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;Immutable Layout configuration&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">environment_file</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">/run/cos/cos-layout.env</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">environment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">VOLUMES</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;LABEL=COS_OEM:/oem LABEL=COS_PERSISTENT:/usr/local&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">OVERLAY</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;tmpfs:25%&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">RW_PATHS</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;/var /etc /srv&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">PERSISTENT_STATE_PATHS</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">&gt;-</span><span style="color:#8f5902;font-style:italic">
</span><span style="color:#8f5902;font-style:italic">          /etc/systemd
</span><span style="color:#8f5902;font-style:italic">          /etc/rancher
</span><span style="color:#8f5902;font-style:italic">          /etc/ssh
</span><span style="color:#8f5902;font-style:italic">          /etc/iscsi 
</span><span style="color:#8f5902;font-style:italic">          /etc/cni
</span><span style="color:#8f5902;font-style:italic">          /home
</span><span style="color:#8f5902;font-style:italic">          /opt
</span><span style="color:#8f5902;font-style:italic">          /root
</span><span style="color:#8f5902;font-style:italic">          /usr/libexec
</span><span style="color:#8f5902;font-style:italic">          /var/log
</span><span style="color:#8f5902;font-style:italic">          /var/lib/rancher
</span><span style="color:#8f5902;font-style:italic">          /var/lib/kubelet
</span><span style="color:#8f5902;font-style:italic">          /var/lib/wicked
</span><span style="color:#8f5902;font-style:italic">          /var/lib/longhorn
</span><span style="color:#8f5902;font-style:italic">          /var/lib/cni</span><span style="color:#f8f8f8;text-decoration:underline">          
</span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">PERSISTENT_STATE_BIND</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;true&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#8f5902;font-style:italic"># Finally, let&#39;s start k3s when network is available, and download the SSH key from github for the joe user</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#204a87;font-weight:bold">network</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">     </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;Start k3s&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#204a87;font-weight:bold">systemctl</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#204a87;font-weight:bold">start</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span><span style="color:#f8f8f8;text-decoration:underline">         </span>- <span style="color:#000">k3s</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">     </span>- <span style="color:#204a87;font-weight:bold">authorized_keys</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">     </span><span style="color:#8f5902;font-style:italic"># Replace here with your ssh keys or github handle</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">joe</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span><span style="color:#f8f8f8;text-decoration:underline">        </span>- <span style="color:#000">github:mudler</span><span style="color:#f8f8f8;text-decoration:underline">
</span></code></pre></div><p>Done! We are now ready to build the Docker container.</p>
<p>The file structure should be like the following:</p>
<pre><code>$&gt; tree ./derivative
derivative
├── cloud-init.yaml
├── Dockerfile
├── iso.yaml
└── repositories.yaml
</code></pre><h2 id="3-build-it">3) Build it!</h2>
<p>Now we are ready to build our docker image:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$~/derivative&gt; docker build -t derivative:latest .
...
 ---&gt; Running in a9c33b42f567                              
Removing intermediate container a9c33b42f567                                                                           
 ---&gt; 8e83191d29df                                                                                                     
Step 19/19 : COPY cloud-init.yaml /system/oem/                                                                         
 ---&gt; 38cc4c8b173a                                                                                                     
Successfully built 38cc4c8b173a                                                                                        
Successfully tagged derivative:latest
</code></pre></div><p>After the process completed, we are ready to consume our docker image. If you push the image over a container registry, you can then or use a running <code>cOS</code> system to upgrade to it, or deploy it directly <a href="../../getting-started">see getting started</a>.</p>
<h3 id="build-an-iso-image">Build an ISO image</h3>
<p>We can at this point also create a ISO from it.</p>
<p>Create a <code>iso.yaml</code> file with the following content inside the <code>derivative</code> folder:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#204a87;font-weight:bold">packages</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">uefi</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">live/grub2-efi-image</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">isoimage</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">live/grub2</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">live/grub2-efi-image</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">boot_file</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;boot/x86_64/loader/eltorito.img&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">boot_catalog</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;boot/x86_64/boot.catalog&#34;</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">isohybrid_mbr</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;boot/x86_64/loader/boot_hybrid.img&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">initramfs</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">kernel_file</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;vmlinuz&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">rootfs_file</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;initrd&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">image_prefix</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;derivative-0.&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">image_date</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">label</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;COS_LIVE&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">luet</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">repositories</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">cOS</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">enable</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">urls</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#000">quay.io/costoolkit/releases-green</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">type</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">docker</span><span style="color:#f8f8f8;text-decoration:underline">
</span></code></pre></div><p>Now, we can build the ISO with:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$~/derivative&gt; docker run -v <span style="color:#000">$PWD</span>:/cOS -v /var/run:/var/run --entrypoint /usr/bin/luet-makeiso -ti --rm quay.io/costoolkit/toolchain ./iso.yaml --image derivative:latest
....
INFO<span style="color:#ce5c00;font-weight:bold">[</span>0114<span style="color:#ce5c00;font-weight:bold">]</span> Copying BIOS kernels                       
INFO<span style="color:#ce5c00;font-weight:bold">[</span>0114<span style="color:#ce5c00;font-weight:bold">]</span> Create squashfs                            
Parallel mksquashfs: Using <span style="color:#0000cf;font-weight:bold">8</span> processors
Creating 4.0 filesystem on /tmp/luet-geniso4082786464/tempISO/rootfs.squashfs, block size 1048576.
....
INFO<span style="color:#ce5c00;font-weight:bold">[</span>0247<span style="color:#ce5c00;font-weight:bold">]</span> 🍹 Generate ISO derivative-0.20210909.iso     
xorriso 1.4.6 : RockRidge filesystem manipulator, libburnia project.

Drive current: -outdev <span style="color:#4e9a06">&#39;stdio:derivative-0.20210909.iso&#39;</span>
Media current: stdio file, overwriteable
Media status : is blank
Media summary: <span style="color:#0000cf;font-weight:bold">0</span> sessions, <span style="color:#0000cf;font-weight:bold">0</span> data blocks, <span style="color:#0000cf;font-weight:bold">0</span> data,  448g free
Added to ISO image: directory <span style="color:#4e9a06">&#39;/&#39;</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#39;/tmp/luet-geniso4082786464/tempISO&#39;</span>
xorriso : UPDATE : <span style="color:#0000cf;font-weight:bold">599</span> files added in <span style="color:#0000cf;font-weight:bold">1</span> seconds
xorriso : UPDATE : <span style="color:#0000cf;font-weight:bold">599</span> files added in <span style="color:#0000cf;font-weight:bold">1</span> seconds
xorriso : NOTE : Copying to System Area: <span style="color:#0000cf;font-weight:bold">512</span> bytes from file <span style="color:#4e9a06">&#39;/tmp/luet-geniso4082786464/tempISO/boot/x86_64/loader/boot_hybrid.img&#39;</span>
xorriso : WARNING : Boot image load size exceeds <span style="color:#0000cf;font-weight:bold">65535</span> blocks of <span style="color:#0000cf;font-weight:bold">512</span> bytes. Will record <span style="color:#0000cf;font-weight:bold">0</span> in El Torito to extend ESP to end-of-medium.
libisofs: NOTE : Aligned image size to cylinder size by <span style="color:#0000cf;font-weight:bold">137</span> blocks
xorriso : UPDATE :  12.35% <span style="color:#204a87;font-weight:bold">done</span>
xorriso : UPDATE :  42.73% <span style="color:#204a87;font-weight:bold">done</span>
ISO image produced: <span style="color:#0000cf;font-weight:bold">282624</span> sectors
Written to medium : <span style="color:#0000cf;font-weight:bold">282624</span> sectors at LBA <span style="color:#0000cf;font-weight:bold">0</span>
Writing to <span style="color:#4e9a06">&#39;stdio:derivative-0.20210909.iso&#39;</span> completed successfully.
</code></pre></div><p>After the process completes, we should have a ISO in our folder ready to be used. See the <a href="../../creating-derivatives/build_iso">build ISOs section</a> for all the available options.</p>
<h2 id="customization">Customization</h2>
<p>Here follows a break down of the steps above</p>
<h3 id="adding-packages">Adding packages</h3>
<p>Feel free to edit the Dockerfile with the packages you want to embed in our image. You can install any packages available in the openSUSE repositories by
tweaking</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Dockerfile" data-lang="Dockerfile"><span style="color:#8f5902;font-style:italic"># Install packages from the base image</span><span style="color:#a40000">
</span><span style="color:#a40000"></span><span style="color:#204a87;font-weight:bold">RUN</span> zypper in -y <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>    .... <span style="color:#8f5902;font-style:italic"># Add more packages here!</span><span style="color:#a40000">
</span></code></pre></div><h3 id="repositories-configuration">Repositories configuration</h3>
<p>We copy the configuration file of <code>luet</code> which just points to cOS repositories with:</p>
<pre><code># Copy the luet config file pointing to the upgrade repository
COPY repositories.yaml /etc/luet/luet.yaml
</code></pre><p>The config file should point to the <code>green</code> <a href="../../getting-started/download#releases">flavor</a> as our derivative will be based on opensuse. It should point to <code>blue</code>, or <code>orange</code> instead if building against Fedora or Ubuntu.</p>
<h3 id="cos-toolkit">cOS toolkit</h3>
<p>We install packages from the cOS toolkit with <code>luet</code>. In this case we pick the basic ones that allows us to install/upgrade immutable cOS derivatives:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Dockerfile" data-lang="Dockerfile"><span style="color:#204a87;font-weight:bold">RUN</span> luet install -y <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>       toolchain/yip <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>       toolchain/luet <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>       utils/installer <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>       system/cos-setup <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>       system/immutable-rootfs <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>       system/grub2-config <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>       system/base-dracut-modules<span style="color:#a40000">
</span></code></pre></div><p>You can check all the available packages <a href="https://cos-toolkit.herokuapp.com/cos-toolkit-green">here</a>, and you can learn more about this in our <a href="../../creating-derivatives">Creating Derivatives section</a>.</p>
<h3 id="system-layout-and-k3s">System layout and k3s</h3>
<p>We set some default layouts and install k3s:</p>
<pre><code># Install k3s server/agent
ENV INSTALL_K3S_VERSION=${K3S_VERSION}
RUN curl -sfL https://get.k3s.io &gt; installer.sh &amp;&amp; \
    INSTALL_K3S_SKIP_START=&quot;true&quot; INSTALL_K3S_SKIP_ENABLE=&quot;true&quot; sh installer.sh &amp;&amp; \
    INSTALL_K3S_SKIP_START=&quot;true&quot; INSTALL_K3S_SKIP_ENABLE=&quot;true&quot; sh installer.sh agent &amp;&amp; \
    rm -rf installer.sh

## System layout

# Required by k3s etc.
RUN mkdir /usr/libexec &amp;&amp; touch /usr/libexec/.keep

# Copy custom files
# COPY files/ /

# Generate initrd
RUN mkinitrd

# OS level configuration
RUN echo &quot;VERSION=999&quot; &gt; /etc/os-release
RUN echo &quot;GRUB_ENTRY_NAME=derivative&quot; &gt;&gt; /etc/os-release
RUN echo &quot;welcome to our derivative&quot; &gt;&gt; /etc/issue.d/01-derivative
</code></pre><p>As our target here is to install <code>k3s</code> we do install both k3s <code>agent</code> and <code>server</code>, so the image can work in both modes. Here we could have installed any service or binary that we want to embed in our container image. We setup the system layout by creating needed paths for <code>k3s</code> and set up a os-release which identifies the OS version. Afterward we regenerate the initrd which is required in order to boot, <a href="../../creating-derivatives/creating_bootable_images/#initrd">see also the Initrd section</a>.</p>
<h3 id="cloud-init-custom-ssh-access">Cloud-init, custom SSH access</h3>
<p>The <code>cloud-init.yaml</code> file above configures a user, <code>joe</code> and attaches a ssh key to it in order to login. It also sets up a default password, which is optional.</p>
<p>To specify any additional ssh key installed within the user, we do:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#204a87;font-weight:bold">network</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#204a87;font-weight:bold">authorized_keys</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">joe</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">github:mudler</span><span style="color:#f8f8f8;text-decoration:underline">
</span></code></pre></div><p>which you can replace with your github handle, or by specifying directly an ssh key. In case you specify the SSH key directly, you don&rsquo;t need to run the step in the <code>network</code> stage.</p>
<p>The user will be part of the <code>admin</code> group which is allowed to use <code>sudo</code>.</p>
<p>As our target is to run <code>k3s</code>, but could have been any other service, we tweak the immutable setup by specifying sensible path required for <code>k3s</code> in order to function properly, see <a href="../../reference/immutable_rootfs">immutable rootfs</a> for all the available options.</p>
<p>Finally, we start k3s. Note, we could have tweaked that part slightly to provide <code>k3s</code> configurations via systemd env files, or boot up for example the agent instead of the server:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#204a87;font-weight:bold">network</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">     </span>- <span style="color:#204a87;font-weight:bold">if</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;[ ! -f &#34;/run/cos/recovery_mode&#34; ]&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;Setup k3s&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#8f5902;font-style:italic"># Setup environment file for custom k3s arguments</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#204a87;font-weight:bold">environment_file</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;/etc/systemd/system/k3s.service.env&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#204a87;font-weight:bold">environment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#204a87;font-weight:bold">FOO</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;bar&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#204a87;font-weight:bold">systemctl</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#204a87;font-weight:bold">start</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span><span style="color:#f8f8f8;text-decoration:underline">         </span>- <span style="color:#000">k3s</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">     </span>- <span style="color:#204a87;font-weight:bold">commands</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">       </span>- <span style="color:#000;font-weight:bold">|</span><span style="color:#8f5902;font-style:italic">
</span><span style="color:#8f5902;font-style:italic">        </span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#000">chmod 600 /etc/systemd/system/k3s.service.env</span><span style="color:#f8f8f8;text-decoration:underline">
</span></code></pre></div><h2 id="references">References</h2>
<p>You can find the complete example <a href="https://github.com/mudler/c3os">here</a> where this article was made from.</p>

</div>



    
	
  



          </main>
        </div>
      </div>
      
<footer class="bg-dark py-5 row d-print-none">
  <div class="container-fluid mx-sm-5">
    <div class="row">
      <div class="col-6 col-sm-4 text-xs-center order-sm-2">
        
        
        
      </div>
      <div class="col-6 col-sm-4 text-right text-xs-center order-sm-3">
        
        
        
<ul class="list-inline mb-0">
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Slack" aria-label="Slack">
    <a class="text-white" target="_blank" rel="noopener" href="https://rancher-users.slack.com/messages/cos-toolkit" aria-label="Slack">
      <i class="fab fa-slack"></i>
    </a>
  </li>
  
</ul>

        
        
      </div>
      <div class="col-12 col-sm-4 text-center py-2 order-sm-2">
        <small class="text-white">&copy; 2022 SUSE LLC All Rights Reserved</small>
        <small class="ml-1"><a href="https://www.suse.com/company/legal/" target="_blank" rel="noopener">Privacy Policy</a></small>
	
		
	
      </div>
    </div>
  </div>
</footer>


    </div>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js" integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.min.js" integrity="sha384-+YQ4JLhjyBLPDQt//I+STsc9iw4uQqACwlvpslubQzn4u2UU2UFM80nGisd026JF" crossorigin="anonymous"></script>






 













<script src="https://rancher-sandbox.github.io/cOS-toolkit/js/main.min.3b172c13b62c2bea8b1c9d2599cddc8cf89718a92d792c680871c81ba43d8c85.js" integrity="sha256-OxcsE7YsK&#43;qLHJ0lmc3cjPiXGKkteSxoCHHIG6Q9jIU=" crossorigin="anonymous"></script>



<script src='https://rancher-sandbox.github.io/cOS-toolkit/js/prism.js'></script>



  </body>
</html>
