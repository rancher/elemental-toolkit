<!doctype html>
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="generator" content="Hugo 0.85.0" /><link rel="canonical" type="text/html" href="https://github.com/rancher-sandbox/cOS-toolkit/docs/reference/">
<META NAME="ROBOTS" CONTENT="NOINDEX, NOFOLLOW">


<link rel="shortcut icon" href="https://github.com/rancher-sandbox/cOS-toolkit/favicons/favicon.ico" >
<link rel="apple-touch-icon" href="https://github.com/rancher-sandbox/cOS-toolkit/favicons/apple-touch-icon-180x180.png" sizes="180x180">
<link rel="icon" type="image/png" href="https://github.com/rancher-sandbox/cOS-toolkit/favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="https://github.com/rancher-sandbox/cOS-toolkit/favicons/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="https://github.com/rancher-sandbox/cOS-toolkit/favicons/android-36x36.png" sizes="36x36">
<link rel="icon" type="image/png" href="https://github.com/rancher-sandbox/cOS-toolkit/favicons/android-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="https://github.com/rancher-sandbox/cOS-toolkit/favicons/android-72x72.png" sizes="72x72">
<link rel="icon" type="image/png" href="https://github.com/rancher-sandbox/cOS-toolkit/favicons/android-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="https://github.com/rancher-sandbox/cOS-toolkit/favicons/android-144x144.png" sizes="144x144">
<link rel="icon" type="image/png" href="https://github.com/rancher-sandbox/cOS-toolkit/favicons/android-192x192.png" sizes="192x192">

<title>Reference | cOS toolkit</title>
<meta name="description" content="cOS toolkit documentation website"><meta property="og:title" content="Reference" />
<meta property="og:description" content="References for cOS derivatives, like common featuresets, high level architecture
" />
<meta property="og:type" content="website" />
<meta property="og:url" content="https://github.com/rancher-sandbox/cOS-toolkit/docs/reference/" /><meta property="og:site_name" content="cOS toolkit" />

<meta itemprop="name" content="Reference">
<meta itemprop="description" content="References for cOS derivatives, like common featuresets, high level architecture
"><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Reference"/>
<meta name="twitter:description" content="References for cOS derivatives, like common featuresets, high level architecture
"/>




<link rel="preload" href="https://github.com/rancher-sandbox/cOS-toolkit/scss/main.min.ce822e1833a5405e77f69584ab31fd4bd422643124926787ea63be001e51b0b2.css" as="style">
<link href="https://github.com/rancher-sandbox/cOS-toolkit/scss/main.min.ce822e1833a5405e77f69584ab31fd4bd422643124926787ea63be001e51b0b2.css" rel="stylesheet" integrity="">


<script
  src="https://code.jquery.com/jquery-3.5.1.min.js"
  integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
  crossorigin="anonymous"></script>

<script
  src="https://unpkg.com/lunr@2.3.8/lunr.min.js"
  integrity="sha384-vRQ9bDyE0Wnu+lMfm57BlYLO0/XauFuKpVsZPs7KEDwYKktWi5+Kz3MP8++DFlRY"
  crossorigin="anonymous"></script>



<link rel="stylesheet" href="https://github.com/rancher-sandbox/cOS-toolkit/css/prism.css"/>





<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-00000000-0', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>


  </head>
  <body class="td-section">
    <header>
      
<nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar">
        <a class="navbar-brand" href="https://github.com/rancher-sandbox/cOS-toolkit/">
		<span class="navbar-logo"><svg id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 500 500" style="enable-background:new 0 0 500 500"><g><path style="fill:#fff" d="M116.8525 421.9722c-5.7041.0-10.3442-4.3127-10.3442-9.6129V88.183c0-5.3002 4.6401-9.6117 10.3442-9.6117H320.858c3.0347.0 9.3959.5498 11.7506 2.6302l.3545.3442 58.905 63.2912c2.3101 2.491 2.9202 8.4928 2.9202 11.3184v256.2039c0 5.3002-4.6407 9.6129-10.3436 9.6129H116.8525z"/><g><g><g><path style="fill:#767676" d="M384.4445 423.2066H116.852c-6.3839.0-11.5786-4.8658-11.5786-10.8474V88.1831c0-5.9804 5.1947-10.8461 11.5786-10.8461h204.0062c.377.0 9.2786.0329 12.568 2.9389l.3947.3833 58.9508 63.337c3.2135 3.4652 3.2514 11.7924 3.2514 12.1593v256.2036C396.0231 418.3408 390.8284 423.2066 384.4445 423.2066zM116.5079 411.9189c.0848.0278.1999.0531.3441.0531h267.5925c.1442.0.2581-.0253.3441-.0531V156.1556c-.0076-.9033-.3593-3.7347-.7034-5.0037l-57.6527-61.9416c-1.4651-.3176-4.4533-.6389-5.5742-.6389H116.852c-.143.0-.2594.024-.3441.0531V411.9189zm267.4533-261.149zM327.0321 89.371v.0013V89.371z"/></g></g></g><g><g><path style="fill:#5b7fc0" d="M189.0874 210.1754l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.025 2.454-11.4897 6.4116-15.4473C177.5953 212.627 183.0601 210.1742 189.0874 210.1754zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403S197.0816 234.1722 197.0804 232.033z"/><path style="opacity:.3;fill:#fff" d="M189.0898 210.176c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 212.6276 183.0612 210.176 189.0898 210.176zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 236.239 197.0839 234.2399 197.0839 232.0372z"/><g><defs><path id="SVGID_1_" d="M194.7376 237.6875c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.999 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 234.2399 196.1861 236.239 194.7376 237.6875z"/></defs><clipPath id="SVGID_2_"><use xlink:href="#SVGID_1_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_2_);fill:#fff" d="M190.0704 225.0237c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 225.7247 191.9774 225.0237 190.0704 225.0237z"/><path style="opacity:.13;clip-path:url(#SVGID_2_);fill:#020202" d="M190.0704 225.0237c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 225.7247 191.9774 225.0237 190.0704 225.0237z"/></g><g><defs><path id="SVGID_3_" d="M189.0898 210.176c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 212.6276 183.0612 210.176 189.0898 210.176zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 236.239 197.0839 234.2399 197.0839 232.0372z"/></defs><clipPath id="SVGID_4_"><use xlink:href="#SVGID_3_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_4_);fill:#5b7fc0" d="M172.6595 215.6045c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8612 12.0547.0024 21.8636-9.797 21.8613-21.8612.0024-3.8475-1.0151-7.6326-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 209.1953 176.6171 211.647 172.6595 215.6045z"/></g></g><rect x="198.8952" y="225.1043" style="fill:#5b7fc0" width="122.6266" height="13.8671"/></g><g><path style="fill:#d95140" d="M189.0874 155.7611l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.0249 2.454-11.4897 6.4116-15.4473C177.5953 158.2128 183.0601 155.7599 189.0874 155.7611zm7.993 21.8577c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403C196.2508 181.7667 197.0816 179.758 197.0804 177.6188z"/><path style="opacity:.3;fill:#fff" d="M189.0898 155.7617c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 158.2134 183.0612 155.7617 189.0898 155.7617zm7.9941 21.8613c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 181.8248 197.0839 179.8256 197.0839 177.623z"/><g><defs><path id="SVGID_5_" d="M194.7376 183.2733c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.9989 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 179.8256 196.1861 181.8248 194.7376 183.2733z"/></defs><clipPath id="SVGID_6_"><use xlink:href="#SVGID_5_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_6_);fill:#fff" d="M190.0704 170.6095c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 171.3104 191.9774 170.6095 190.0704 170.6095z"/><path style="opacity:.13;clip-path:url(#SVGID_6_);fill:#020202" d="M190.0704 170.6095c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 171.3104 191.9774 170.6095 190.0704 170.6095z"/></g><g><defs><path id="SVGID_7_" d="M189.0898 155.7617c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 158.2134 183.0612 155.7617 189.0898 155.7617zm7.9941 21.8613c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 181.8248 197.0839 179.8256 197.0839 177.623z"/></defs><clipPath id="SVGID_8_"><use xlink:href="#SVGID_7_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_8_);fill:#d95140" d="M172.6595 161.1903c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8613 12.0547.0024 21.8636-9.797 21.8613-21.8613.0024-3.8474-1.0151-7.6326-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 154.7811 176.6171 157.2327 172.6595 161.1903z"/></g><rect x="198.8952" y="170.69" style="fill:#d95140" width="122.6266" height="13.8671"/></g><g><g><path style="fill:#56a55c" d="M189.5379 264.6147l.0012-.0012c7.7751.0012 15.0294 4.1862 18.932 10.9235 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032-5.8394.0-11.3281-2.2733-15.458-6.4032-4.13-4.13-6.4032-9.6186-6.4056-15.4628.0012-6.0249 2.454-11.4897 6.4116-15.4472C178.0458 267.0663 183.5105 264.6135 189.5379 264.6147zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6538 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403C196.7013 290.6202 197.5321 288.6115 197.5309 286.4723z"/><path style="opacity:.3;fill:#fff" d="M189.5403 264.6153c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8065-21.8612-21.8613.0-6.0285 2.4516-11.492 6.4116-15.452C178.0482 267.0669 183.5117 264.6153 189.5403 264.6153zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.6366 290.6783 197.5344 288.6792 197.5344 286.4765z"/><g><defs><path id="SVGID_9_" d="M195.1881 292.1268c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.9989 7.9942-7.9941 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.5344 288.6792 196.6366 290.6783 195.1881 292.1268z"/></defs><clipPath id="SVGID_10_"><use xlink:href="#SVGID_9_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_10_);fill:#fff" d="M190.5209 279.463c-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7446-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9941 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C194.239 280.164 192.4279 279.463 190.5209 279.463z"/><path style="opacity:.13;clip-path:url(#SVGID_10_);fill:#020202" d="M190.5209 279.463c-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7446-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9941 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C194.239 280.164 192.4279 279.463 190.5209 279.463z"/></g><g><defs><path id="SVGID_11_" d="M189.5403 264.6153c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8065-21.8612-21.8613.0-6.0285 2.4516-11.492 6.4116-15.452C178.0482 267.0669 183.5117 264.6153 189.5403 264.6153zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.6366 290.6783 197.5344 288.6792 197.5344 286.4765z"/></defs><clipPath id="SVGID_12_"><use xlink:href="#SVGID_11_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_12_);fill:#56a55c" d="M173.11 270.0439c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8613 12.0547.0024 21.8636-9.797 21.8613-21.8613.0024-3.8474-1.0151-7.6326-2.9353-10.9462-3.8977-6.7325-11.1497-10.9151-18.926-10.9151C182.5311 263.6346 177.0676 266.0863 173.11 270.0439z"/></g></g><rect x="199.3456" y="279.5436" style="fill:#56a55c" width="122.6266" height="13.8671"/></g><g><g><path style="fill:#f1bc42" d="M189.0874 318.7208l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3305-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.025 2.454-11.4897 6.4116-15.4472C177.5953 321.1724 183.0601 318.7196 189.0874 318.7208zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403S197.0816 342.7176 197.0804 340.5784z"/><path style="opacity:.3;fill:#fff" d="M189.0898 318.7214c7.7763.0 15.0283 4.1826 18.926 10.915 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8612-12.0547.0024-21.8636-9.8065-21.8612-21.8612.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 321.173 183.0612 318.7214 189.0898 318.7214zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 344.7844 197.0839 342.7853 197.0839 340.5826z"/><g><defs><path id="SVGID_13_" d="M194.7376 346.2329c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.999 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 342.7853 196.1861 344.7844 194.7376 346.2329z"/></defs><clipPath id="SVGID_14_"><use xlink:href="#SVGID_13_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_14_);fill:#fff" d="M190.0704 333.5691c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0834 6.1218 2.8788C193.7885 334.2701 191.9774 333.5691 190.0704 333.5691z"/><path style="opacity:.13;clip-path:url(#SVGID_14_);fill:#020202" d="M190.0704 333.5691c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0834 6.1218 2.8788C193.7885 334.2701 191.9774 333.5691 190.0704 333.5691z"/></g><g><defs><path id="SVGID_15_" d="M189.0898 318.7214c7.7763.0 15.0283 4.1826 18.926 10.915 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8612-12.0547.0024-21.8636-9.8065-21.8612-21.8612.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 321.173 183.0612 318.7214 189.0898 318.7214zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 344.7844 197.0839 342.7853 197.0839 340.5826z"/></defs><clipPath id="SVGID_16_"><use xlink:href="#SVGID_15_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_16_);fill:#f1bc42" d="M172.6595 324.15c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8612 12.0547.0024 21.8636-9.797 21.8613-21.8612.0024-3.8474-1.0151-7.6327-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 317.7407 176.6171 320.1924 172.6595 324.15z"/></g></g><rect x="198.8952" y="333.6497" style="fill:#f1bc42" width="122.6266" height="13.8671"/></g></g></svg></span><span class="text-uppercase font-weight-bold">cOS toolkit</span>
	</a>
	<div class="td-navbar-nav-scroll ml-md-auto" id="main_navbar">
		<ul class="navbar-nav mt-2 mt-lg-0">
			
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				
				
				<a class="nav-link active" href="https://github.com/rancher-sandbox/cOS-toolkit/docs/" ><span class="active">Documentation</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				<a class="nav-link" href="https://github.com/rancher-sandbox/cOS-toolkit/releases" target="_blank" ><i class='fab fa-github'></i><span>Github releases</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				<a class="nav-link" href="https://rancher-sandbox.github.io/cos-toolkit-package-browser/" target="_blank" ><i class='fa fa-toolbox'></i><span>Browse packages</span></a>
			</li>
			
			
			
		</ul>
	</div>
	<div class="navbar-nav d-none d-lg-block">



<input
  type="search"
  class="form-control td-search-input"
  placeholder="&#xf002; Search this site…"
  aria-label="Search this site…"
  autocomplete="off"
  
  data-offline-search-index-json-src="https://github.com/rancher-sandbox/cOS-toolkit/offline-search-index.16218b789da3ed98fdbaeb49bd2ae2d0.json"
  data-offline-search-base-href="https://github.com/rancher-sandbox/cOS-toolkit/"
  data-offline-search-max-results="10"
>

</div>
</nav>

    </header>
    <div class="container-fluid td-outer">
      <div class="td-main">
        <div class="row flex-xl-nowrap">
          <div class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none">
          </div>
          <div class="d-none d-xl-block col-xl-2 td-toc d-print-none">
          </div>
          <main class="col-12 col-md-9 col-xl-8 pl-md-5" role="main">
            




<div class="td-content">
<div class="pageinfo pageinfo-primary d-print-none">
<p>
This the multi-page printable view of this section.
<a href="#" onclick="print();return false;">Click here to print</a>.
</p><p>
<a href="https://github.com/rancher-sandbox/cOS-toolkit/docs/reference/">Return to the regular view of this page</a>.
</p>
</div>



<h1 class="title">Reference</h1>
<div class="lead">References for cOS derivatives, like common featuresets, high level architecture</div>




    <ul>
    
  
  
  
  

  
    
    
	
<li>1: <a href="#pg-533eb9e0a241df35bd13c7d531fc6bd3">Cloud-init support</a></li>


    
  
    
    
	
<li>2: <a href="#pg-64a39672b943eab91a6153baf2fc487f">SELinux</a></li>


    
  
    
    
	
<li>3: <a href="#pg-bd2c7a111cdf07391221b169f69faaa1">Known issues</a></li>


    
  
    
    
	
<li>4: <a href="#pg-64cdd9f4dae5e1e36b28a390789e7b34">Runtime layout</a></li>


    
  
    
    
	
<li>5: <a href="#pg-cf896bdd96bc95a1c5079a49e2dd0b00">Immutable Root Filesystem</a></li>


    
  
    
    
	
<li>6: <a href="#pg-071ba6d3efabf269c535d8df6613a33c">Package reference documentation</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>6.1: <a href="#pg-6a3ead1af1706490161648c4b6020882">Cloud config packages</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>6.1.1: <a href="#pg-f2ca177fa7c53b8937746af159835536">cloud-config/boot-assessment</a></li>


    
  

    </ul>
    
  
    
    
	
<li>6.2: <a href="#pg-f88126e2014aaca7f42ad5e31b8a017a">GRUB</a></li>


    
    <ul>
        
  
  
  
  

  

    </ul>
    
  
    
    
	
<li>6.3: <a href="#pg-38a488e2fb8d5af933f04fa04ae06c0f">Meta packages</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>6.3.1: <a href="#pg-2ee14c4414706eb4e3550293ae147e56">meta/cos-core</a></li>


    
  
    
    
	
<li>6.3.2: <a href="#pg-20f0dfa30c6acbc13f3bda70a14963b6">meta/cos-minimal</a></li>


    
  
    
    
	
<li>6.3.3: <a href="#pg-936dc212b34efd945dfb5c1c8055923d">meta/cos-modules</a></li>


    
  
    
    
	
<li>6.3.4: <a href="#pg-cd398c4a96ce6315b3ed8413b9677a10">meta/cos-verify</a></li>


    
  
    
    
	
<li>6.3.5: <a href="#pg-2d0403630e1a722c86e82297c9ab7b8b">meta/toolchain</a></li>


    
  

    </ul>
    
  
    
    
	
<li>6.4: <a href="#pg-814d9b5826621eca5843f5b6b91b4244">system/cos-wrapper</a></li>


    
  
    
    
	
<li>6.5: <a href="#pg-0e1e2a51c8326695b76478a4bbcb1f0f">system/dracut-initrd</a></li>


    
  
    
    
	
<li>6.6: <a href="#pg-b1dbc1c48316ba68af1f8b953282ae48">system/immutable-rootfs</a></li>


    
  
    
    
	
<li>6.7: <a href="#pg-963179f6f5bbd1cd10ee6ac9f8a021f8">utils/installer</a></li>


    
  
    
    
	
<li>6.8: <a href="#pg-b776ece418034168ac1443ec311f82df">system/kernel</a></li>


    
  

    </ul>
    
  
    
    
	
<li>7: <a href="#pg-96caa056902ceb82a4f9a52e36852e8c">Troubleshooting</a></li>


    
  
    
    
	
<li>8: <a href="#pg-52dc75d922e47809f6e4b3a9ac43e7a8">High level architecture</a></li>


    
  

    </ul>


<div class="content">
      <ul>
<li><a href="https://github.com/mudler/cOS/projects/1">Github project</a> for a short-term Roadmap</li>
</ul>
<h3 id="samples-repositories">Samples repositories</h3>
<ul>
<li><a href="https://github.com/rancher-sandbox/cos-fleet-upgrades-sample">Build a derivative and upgrade it with fleet</a></li>
</ul>

</div>
</div>


  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-533eb9e0a241df35bd13c7d531fc6bd3">1 - Cloud-init support</h1>
    <div class="lead">Features inherited by cOS derivatives that are also available in the cOS vanilla images</div>
	<p>Below is a reference of all keys available in the cloud-init style files.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#204a87;font-weight:bold">stages</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#8f5902;font-style:italic"># &#34;network&#34; is the stage where network is expected to be up</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#8f5902;font-style:italic"># It is called internally when network is available from </span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#8f5902;font-style:italic"># the cos-setup-network unit.</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#204a87;font-weight:bold">network</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">     </span><span style="color:#8f5902;font-style:italic"># Here there are a list of </span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">     </span><span style="color:#8f5902;font-style:italic"># steps to be run in the network stage</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">     </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;Some setup happening&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#204a87;font-weight:bold">files</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">        </span>- <span style="color:#204a87;font-weight:bold">path</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">/tmp/foo</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">content</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">|</span><span style="color:#8f5902;font-style:italic">
</span><span style="color:#8f5902;font-style:italic">                    </span><span style="color:#f8f8f8;text-decoration:underline">                    </span><span style="color:#000">test</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">permissions</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0777</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">owner</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1000</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">group</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">100</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#204a87;font-weight:bold">commands</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">        </span>- <span style="color:#000">echo &#34;test&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#204a87;font-weight:bold">modules</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">       </span>- <span style="color:#000">nvidia</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#204a87;font-weight:bold">environment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#204a87;font-weight:bold">FOO</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;bar&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#204a87;font-weight:bold">systctl</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#204a87;font-weight:bold">debug.exception-trace</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;0&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#204a87;font-weight:bold">hostname</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;foo&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#204a87;font-weight:bold">systemctl</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#204a87;font-weight:bold">enable</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">         </span>- <span style="color:#000">foo</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#204a87;font-weight:bold">disable</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">         </span>- <span style="color:#000">bar</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#204a87;font-weight:bold">start</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">         </span>- <span style="color:#000">baz</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#204a87;font-weight:bold">mask</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">         </span>- <span style="color:#000">foobar</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#204a87;font-weight:bold">authorized_keys</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">user</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">          </span>- <span style="color:#4e9a06">&#34;github:mudler&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">          </span>- <span style="color:#4e9a06">&#34;ssh-rsa ....&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#204a87;font-weight:bold">dns</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#204a87;font-weight:bold">path</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">/etc/resolv.conf</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#204a87;font-weight:bold">nameservers</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">         </span>- <span style="color:#0000cf;font-weight:bold">8.8.8.8</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#204a87;font-weight:bold">ensure_entities</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">       </span>- <span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">path</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">/etc/passwd</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">entity</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">|</span><span style="color:#8f5902;font-style:italic">
</span><span style="color:#8f5902;font-style:italic">                  kind: &#34;user&#34;
</span><span style="color:#8f5902;font-style:italic">                  username: &#34;foo&#34;
</span><span style="color:#8f5902;font-style:italic">                  password: &#34;pass&#34;
</span><span style="color:#8f5902;font-style:italic">                  uid: 0
</span><span style="color:#8f5902;font-style:italic">                  gid: 0
</span><span style="color:#8f5902;font-style:italic">                  info: &#34;Foo!&#34;
</span><span style="color:#8f5902;font-style:italic">                  homedir: &#34;/home/foo&#34;
</span><span style="color:#8f5902;font-style:italic">                  shell: &#34;/bin/bash&#34;</span><span style="color:#f8f8f8;text-decoration:underline">                  
</span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#204a87;font-weight:bold">delete_entities</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">       </span>- <span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">path</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">/etc/passwd</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">entity</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">|</span><span style="color:#8f5902;font-style:italic">
</span><span style="color:#8f5902;font-style:italic">                  kind: &#34;user&#34;
</span><span style="color:#8f5902;font-style:italic">                  username: &#34;foo&#34;
</span><span style="color:#8f5902;font-style:italic">                  password: &#34;pass&#34;
</span><span style="color:#8f5902;font-style:italic">                  uid: 0
</span><span style="color:#8f5902;font-style:italic">                  gid: 0
</span><span style="color:#8f5902;font-style:italic">                  info: &#34;Foo!&#34;
</span><span style="color:#8f5902;font-style:italic">                  homedir: &#34;/home/foo&#34;
</span><span style="color:#8f5902;font-style:italic">                  shell: &#34;/bin/bash&#34;</span><span style="color:#f8f8f8;text-decoration:underline">                  
</span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#204a87;font-weight:bold">datasource</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#204a87;font-weight:bold">providers</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">         </span>- <span style="color:#4e9a06">&#34;aws&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">         </span>- <span style="color:#4e9a06">&#34;digitalocean&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#204a87;font-weight:bold">path</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;/etc/cloud-data&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></code></pre></div><p>The default cloud-config format is split into <em>stages</em> (<em>initramfs</em>, <em>boot</em>, <em>network</em>, <em>initramfs</em>, <em>reconcile</em>, called generically <strong>STAGE_ID</strong> below) <a href="../customizing/stages">see also stages</a> that are emitted internally during the various phases by calling <code>cos-setup STAGE_ID</code>.
<em>steps</em> (<strong>STEP_NAME</strong> below) defined for each stage are executed in order.</p>
<p>Each cloud-config file is loaded and executed only at the apprioriate stage, this allows further components to emit their own stages at the desired time.</p>


<div class="pageinfo pageinfo-primary">
<p>The <a href="https://github.com/mudler/yip#readme">cloud-init tool</a> can be also run standalone, this helps debugging locally and also during development, you can find separate <a href="https://github.com/mudler/yip/releases/tag/0.9.6">releases here</a>, or just run it with docker:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">cat <span style="color:#4e9a06">&lt;&lt;EOF | docker run -i --rm quay.io/costoolkit/releases-green:cos-recovery-0.6.0 yip -s test -
</span><span style="color:#4e9a06">stages:
</span><span style="color:#4e9a06"> test:
</span><span style="color:#4e9a06"> - commands:
</span><span style="color:#4e9a06">   - echo &#34;test&#34;
</span><span style="color:#4e9a06">EOF</span>
</code></pre></div>
</div>

<p><em>Note</em>: Each cloud-init option can be either run in <em>dot notation</em> ( e.g. <code>stages.network[0].authorized_keys.user=github:user</code> ) in the boot args or either can supply a cloud-init URL at boot with the <code>cos.setup=$URL</code> parameter.</p>
<h3 id="using-templates">Using templates</h3>
<p>With Cloud Init support, templates can be used to allow dynamic configuration. More information about templates can be found <a href="https://github.com/mudler/yip#node-data-interpolation">here</a> and also <a href="http://masterminds.github.io/sprig/">here for sprig</a> functions.</p>
<h3 id="compatibility-with-cloud-init-format">Compatibility with Cloud Init format</h3>
<p>A subset of the official <a href="http://cloudinit.readthedocs.org/en/latest/topics/format.html#cloud-config-data">cloud-config spec</a> is implemented.</p>
<p>If a yaml file starts with <code>#cloud-config</code> it is parsed as a standard cloud-init and automatically associated it to the <code>boot</code> stage. For example:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#8f5902;font-style:italic">#cloud-config</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">growpart</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">mode</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">auto</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">devices</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#39;/&#39;</span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">users</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;bar&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">passwd</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;foo&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">lock_passwd</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">uid</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;1002&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">groups</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;users&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">ssh_authorized_keys</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">faaapploo</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">ssh_authorized_keys</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">asdd</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">runcmd</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#000">foo</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">hostname</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;bar&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">write_files</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#204a87;font-weight:bold">encoding</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">b64</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">content</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">CiMgVGhpcyBmaWxlIGNvbnRyb2xzIHRoZSBzdGF0ZSBvZiBTRUxpbnV4</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">path</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">/foo/bar</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">permissions</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;0644&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">owner</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;bar&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></code></pre></div><p>Is executed at boot, by using the standard <code>cloud-config</code> format.</p>
<h3 id="stagesstage_idstep_namename"><code>stages.STAGE_ID.STEP_NAME.name</code></h3>
<p>A description of the stage step. Used only when printing output to console.</p>
<h3 id="stagesstage_idstep_namefiles"><code>stages.STAGE_ID.STEP_NAME.files</code></h3>
<p>A list of files to write to disk.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#204a87;font-weight:bold">stages</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#204a87;font-weight:bold">default</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">     </span>- <span style="color:#204a87;font-weight:bold">files</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">        </span>- <span style="color:#204a87;font-weight:bold">path</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">/tmp/bar</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">content</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">|</span><span style="color:#8f5902;font-style:italic">
</span><span style="color:#8f5902;font-style:italic">                    #!/bin/sh
</span><span style="color:#8f5902;font-style:italic">                    echo &#34;test&#34;</span><span style="color:#f8f8f8;text-decoration:underline">                    
</span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">permissions</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0777</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">owner</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1000</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">group</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">100</span><span style="color:#f8f8f8;text-decoration:underline">
</span></code></pre></div><h3 id="stagesstage_idstep_namedirectories"><code>stages.STAGE_ID.STEP_NAME.directories</code></h3>
<p>A list of directories to be created on disk. Runs before <code>files</code>.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#204a87;font-weight:bold">stages</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#204a87;font-weight:bold">default</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">     </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;Setup folders&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#204a87;font-weight:bold">directories</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">       </span>- <span style="color:#204a87;font-weight:bold">path</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;/etc/foo&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#204a87;font-weight:bold">permissions</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0600</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#204a87;font-weight:bold">owner</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#204a87;font-weight:bold">group</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline">
</span></code></pre></div><h3 id="stagesstage_idstep_namedns"><code>stages.STAGE_ID.STEP_NAME.dns</code></h3>
<p>A way to configure the <code>/etc/resolv.conf</code> file.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#204a87;font-weight:bold">stages</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#204a87;font-weight:bold">default</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">     </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;Setup dns&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#204a87;font-weight:bold">dns</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#204a87;font-weight:bold">nameservers</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">         </span>- <span style="color:#0000cf;font-weight:bold">8.8.8.8</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">         </span>- <span style="color:#0000cf;font-weight:bold">1.1.1.1</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#204a87;font-weight:bold">search</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">         </span>- <span style="color:#000">foo.bar</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#204a87;font-weight:bold">options</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">         </span>- <span style="color:#000">..</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#204a87;font-weight:bold">path</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;/etc/resolv.conf.bak&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></code></pre></div><h3 id="stagesstage_idstep_namehostname"><code>stages.STAGE_ID.STEP_NAME.hostname</code></h3>
<p>A string representing the machine hostname. It sets it in the running system, updates <code>/etc/hostname</code> and adds the new hostname to <code>/etc/hosts</code>.
Templates can be used to allow dynamic configuration. For example in mass-install scenario it could be needed (and easier) to specify hostnames for multiple machines from a single cloud-init config file.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#204a87;font-weight:bold">stages</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#204a87;font-weight:bold">default</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">     </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;Setup hostname&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#204a87;font-weight:bold">hostname</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;node-{{ trunc 4 .MachineID }}&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></code></pre></div><h3 id="stagesstage_idstep_namesysctl"><code>stages.STAGE_ID.STEP_NAME.sysctl</code></h3>
<p>Kernel configuration. It sets <code>/proc/sys/&lt;key&gt;</code> accordingly, similarly to <code>sysctl</code>.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#204a87;font-weight:bold">stages</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#204a87;font-weight:bold">default</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">     </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;Setup exception trace&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#204a87;font-weight:bold">systctl</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#204a87;font-weight:bold">debug.exception-trace</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;0&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></code></pre></div><h3 id="stagesstage_idstep_nameauthorized_keys"><code>stages.STAGE_ID.STEP_NAME.authorized_keys</code></h3>
<p>A list of SSH authorized keys that should be added for each user.
SSH keys can be obtained from GitHub user accounts by using the format github:${USERNAME},  similarly for Gitlab with gitlab:${USERNAME}.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#204a87;font-weight:bold">stages</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#204a87;font-weight:bold">default</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">     </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;Setup exception trace&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#204a87;font-weight:bold">authorized_keys</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#204a87;font-weight:bold">mudler</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">         </span>- <span style="color:#000">github:mudler</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">         </span>- <span style="color:#204a87;font-weight:bold">ssh-rsa</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">...</span><span style="color:#f8f8f8;text-decoration:underline">
</span></code></pre></div><h3 id="stagesstage_idstep_namenode"><code>stages.STAGE_ID.STEP_NAME.node</code></h3>
<p>If defined, the node hostname where this stage has to run, otherwise it skips the execution. The node can be also a regexp in the Golang format.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#204a87;font-weight:bold">stages</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#204a87;font-weight:bold">default</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">     </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;Setup logging&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#204a87;font-weight:bold">node</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;bastion&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></code></pre></div><h3 id="stagesstage_idstep_nameusers"><code>stages.STAGE_ID.STEP_NAME.users</code></h3>
<p>A map of users and user info to set. Passwords can be also encrypted.</p>
<p>The <code>users</code> parameter adds or modifies the specified list of users. Each user is an object which consists of the following fields. Each field is optional and of type string unless otherwise noted.
In case the user is already existing, the entry is ignored.</p>
<ul>
<li><strong>name</strong>: Required. Login name of user</li>
<li><strong>gecos</strong>: GECOS comment of user</li>
<li><strong>passwd</strong>: Hash of the password to use for this user. Unencrypted strings are supported too.</li>
<li><strong>homedir</strong>: User&rsquo;s home directory. Defaults to /home/<em>name</em></li>
<li><strong>no-create-home</strong>: Boolean. Skip home directory creation.</li>
<li><strong>primary-group</strong>: Default group for the user. Defaults to a new group created named after the user.</li>
<li><strong>groups</strong>: Add user to these additional groups</li>
<li><strong>no-user-group</strong>: Boolean. Skip default group creation.</li>
<li><strong>ssh-authorized-keys</strong>: List of public SSH keys to authorize for this user</li>
<li><strong>system</strong>: Create the user as a system user. No home directory will be created.</li>
<li><strong>no-log-init</strong>: Boolean. Skip initialization of lastlog and faillog databases.</li>
<li><strong>shell</strong>: User&rsquo;s login shell.</li>
</ul>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#204a87;font-weight:bold">stages</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#204a87;font-weight:bold">default</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">     </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;Setup users&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#204a87;font-weight:bold">users</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">bastion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#204a87;font-weight:bold">passwd</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;strongpassword&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#204a87;font-weight:bold">homedir</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">&#34;/home/foo</span><span style="color:#f8f8f8;text-decoration:underline">
</span></code></pre></div><h3 id="stagesstage_idstep_nameensure_entities"><code>stages.STAGE_ID.STEP_NAME.ensure_entities</code></h3>
<p>A <code>user</code> or a <code>group</code> in the <a href="https://github.com/mudler/entities">entity</a> format to be configured in the system</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#204a87;font-weight:bold">stages</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#204a87;font-weight:bold">default</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">     </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;Setup users&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#204a87;font-weight:bold">ensure_entities</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">       </span>- <span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">path</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">/etc/passwd</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">entity</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">|</span><span style="color:#8f5902;font-style:italic">
</span><span style="color:#8f5902;font-style:italic">                  kind: &#34;user&#34;
</span><span style="color:#8f5902;font-style:italic">                  username: &#34;foo&#34;
</span><span style="color:#8f5902;font-style:italic">                  password: &#34;x&#34;
</span><span style="color:#8f5902;font-style:italic">                  uid: 0
</span><span style="color:#8f5902;font-style:italic">                  gid: 0
</span><span style="color:#8f5902;font-style:italic">                  info: &#34;Foo!&#34;
</span><span style="color:#8f5902;font-style:italic">                  homedir: &#34;/home/foo&#34;
</span><span style="color:#8f5902;font-style:italic">                  shell: &#34;/bin/bash&#34;</span><span style="color:#f8f8f8;text-decoration:underline">                  
</span></code></pre></div><h3 id="stagesstage_idstep_namedelete_entities"><code>stages.STAGE_ID.STEP_NAME.delete_entities</code></h3>
<p>A <code>user</code> or a <code>group</code> in the <a href="https://github.com/mudler/entities">entity</a> format to be pruned from the system</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#204a87;font-weight:bold">stages</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#204a87;font-weight:bold">default</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">     </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;Setup users&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#204a87;font-weight:bold">delete_entities</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">       </span>- <span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">path</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">/etc/passwd</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">entity</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">|</span><span style="color:#8f5902;font-style:italic">
</span><span style="color:#8f5902;font-style:italic">                  kind: &#34;user&#34;
</span><span style="color:#8f5902;font-style:italic">                  username: &#34;foo&#34;
</span><span style="color:#8f5902;font-style:italic">                  password: &#34;x&#34;
</span><span style="color:#8f5902;font-style:italic">                  uid: 0
</span><span style="color:#8f5902;font-style:italic">                  gid: 0
</span><span style="color:#8f5902;font-style:italic">                  info: &#34;Foo!&#34;
</span><span style="color:#8f5902;font-style:italic">                  homedir: &#34;/home/foo&#34;
</span><span style="color:#8f5902;font-style:italic">                  shell: &#34;/bin/bash&#34;</span><span style="color:#f8f8f8;text-decoration:underline">                  
</span></code></pre></div><h3 id="stagesstage_idstep_namemodules"><code>stages.STAGE_ID.STEP_NAME.modules</code></h3>
<p>A list of kernel modules to load.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#204a87;font-weight:bold">stages</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#204a87;font-weight:bold">default</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">     </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;Setup users&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#204a87;font-weight:bold">modules</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">       </span>- <span style="color:#000">nvidia</span><span style="color:#f8f8f8;text-decoration:underline">
</span></code></pre></div><h3 id="stagesstage_idstep_namesystemctl"><code>stages.STAGE_ID.STEP_NAME.systemctl</code></h3>
<p>A list of systemd services to <code>enable</code>, <code>disable</code>, <code>mask</code> or <code>start</code>.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#204a87;font-weight:bold">stages</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#204a87;font-weight:bold">default</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">     </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;Setup users&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#204a87;font-weight:bold">systemctl</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#204a87;font-weight:bold">enable</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">          </span>- <span style="color:#000">systemd-timesyncd</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">          </span>- <span style="color:#000">cronie</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#204a87;font-weight:bold">mask</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">          </span>- <span style="color:#000">purge-kernels</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#204a87;font-weight:bold">disable</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">          </span>- <span style="color:#000">crond</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#204a87;font-weight:bold">start</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">          </span>- <span style="color:#000">cronie</span><span style="color:#f8f8f8;text-decoration:underline">
</span></code></pre></div><h3 id="stagesstage_idstep_nameenvironment"><code>stages.STAGE_ID.STEP_NAME.environment</code></h3>
<p>A map of variables to write in <code>/etc/environment</code>, or otherwise specified in <code>environment_file</code></p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#204a87;font-weight:bold">stages</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#204a87;font-weight:bold">default</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">     </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;Setup users&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#204a87;font-weight:bold">environment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#204a87;font-weight:bold">FOO</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;bar&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></code></pre></div><h3 id="stagesstage_idstep_nameenvironment_file"><code>stages.STAGE_ID.STEP_NAME.environment_file</code></h3>
<p>A string to specify where to set the environment file</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#204a87;font-weight:bold">stages</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#204a87;font-weight:bold">default</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">     </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;Setup users&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#204a87;font-weight:bold">environment_file</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;/home/user/.envrc&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#204a87;font-weight:bold">environment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#204a87;font-weight:bold">FOO</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;bar&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></code></pre></div><h3 id="stagesstage_idstep_nametimesyncd"><code>stages.STAGE_ID.STEP_NAME.timesyncd</code></h3>
<p>Sets the <code>systemd-timesyncd</code> daemon file (<code>/etc/system/timesyncd.conf</code>) file accordingly. The documentation for <code>timesyncd</code> and all the options can be found <a href="https://www.freedesktop.org/software/systemd/man/timesyncd.conf.html">here</a>.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#204a87;font-weight:bold">stages</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#204a87;font-weight:bold">default</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">     </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;Setup NTP&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#204a87;font-weight:bold">systemctl</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#204a87;font-weight:bold">enable</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">         </span>- <span style="color:#000">systemd-timesyncd</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#204a87;font-weight:bold">timesyncd</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">NTP</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;0.pool.org foo.pool.org&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">FallbackNTP</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#000">...</span><span style="color:#f8f8f8;text-decoration:underline">
</span></code></pre></div><h3 id="stagesstage_idstep_namecommands"><code>stages.STAGE_ID.STEP_NAME.commands</code></h3>
<p>A list of arbitrary commands to run after file writes and directory creation.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#204a87;font-weight:bold">stages</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#204a87;font-weight:bold">default</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">     </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;Setup something&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#204a87;font-weight:bold">commands</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">         </span>- <span style="color:#000">echo 1 &gt; /bar</span><span style="color:#f8f8f8;text-decoration:underline">
</span></code></pre></div><h3 id="stagesstage_idstep_namedatasource"><code>stages.STAGE_ID.STEP_NAME.datasource</code></h3>
<p>Sets to fetch user data from the specified cloud providers. It populates
provider specific data into <code>/run/config</code> folder and the custom user data
is stored into the provided path.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#204a87;font-weight:bold">stages</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#204a87;font-weight:bold">default</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">     </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;Fetch cloud provider&#39;s user data&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#204a87;font-weight:bold">datasource</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#204a87;font-weight:bold">providers</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">         </span>- <span style="color:#4e9a06">&#34;aws&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">         </span>- <span style="color:#4e9a06">&#34;digitalocean&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#204a87;font-weight:bold">path</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;/etc/cloud-data&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></code></pre></div><h3 id="stagesstage_idstep_namelayout"><code>stages.STAGE_ID.STEP_NAME.layout</code></h3>
<p>Sets additional partitions on disk free space, if any, and/or expands the last
partition. All sizes are expressed in MiB only and default value of <code>size: 0</code>
means all available free space in disk. This plugin is useful to be used in
oem images where the default partitions might not suit the actual disk geometry.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#204a87;font-weight:bold">stages</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#204a87;font-weight:bold">default</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">     </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;Repart disk&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#204a87;font-weight:bold">layout</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#204a87;font-weight:bold">device</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">           </span><span style="color:#8f5902;font-style:italic"># It will partition a device including the given filesystem label</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">           </span><span style="color:#8f5902;font-style:italic"># or partition label (filesystem label matches first) or the device</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">           </span><span style="color:#8f5902;font-style:italic"># provided in &#39;path&#39;. The label check has precedence over path when</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">           </span><span style="color:#8f5902;font-style:italic"># both are provided.</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">           </span><span style="color:#204a87;font-weight:bold">label</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;COS_RECOVERY&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">           </span><span style="color:#204a87;font-weight:bold">path</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;/dev/sda&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#8f5902;font-style:italic"># Only last partition can be expanded and it happens before any other</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#8f5902;font-style:italic"># partition is added. size: 0 means all available free space</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#204a87;font-weight:bold">expand_partition</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">           </span><span style="color:#204a87;font-weight:bold">size</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">4096</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#204a87;font-weight:bold">add_partitions</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">           </span>- <span style="color:#204a87;font-weight:bold">fsLabel</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;COS_STATE&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">             </span><span style="color:#204a87;font-weight:bold">size</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">8192</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">             </span><span style="color:#8f5902;font-style:italic"># No partition label is applied if omitted</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">             </span><span style="color:#204a87;font-weight:bold">pLabel</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;state&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">           </span>- <span style="color:#204a87;font-weight:bold">fsLabel</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;COS_PERSISTENT&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">             </span><span style="color:#8f5902;font-style:italic"># default filesystem is ext2 if omitted</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">             </span><span style="color:#204a87;font-weight:bold">filesystem</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;ext4&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-64a39672b943eab91a6153baf2fc487f">2 - SELinux</h1>
    <div class="lead">Build SELinux policies with cOS</div>
	<p>You can create a sample policy by using  <code>audit2allow</code> after running some
basic operations in permissive mode using system default policies. <code>allow2audit</code>
translates audit messages into allow/dontaudit SELinux policies which can be later
compiled as a SELinux module. This is the approach used in this illustration
example and mostly follows <code>audit2allow</code> <a href="https://linux.die.net/man/1/audit2allow">man pages</a>.</p>
<p>Once you have generated your policy (<code>mypolicy.te</code>) you can create a selinux package (create a new folder with <code>build.yaml</code>, <code>definition.yaml</code> and <code>mypolicy.te</code>) like so:</p>
<p>build.yaml:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#204a87;font-weight:bold">requires</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;selinux-policies&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">category</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;system&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">version</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;&gt;=0&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">env</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#000">MODULE_NAME=mypolicy</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">steps</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#000">sed -i &#34;s|^SELINUX=.*|SELINUX=permissive|g&#34; /etc/selinux/config</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#000">rm -rf /.autorelabel</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#000">checkmodule -M -m -o ${MODULE_NAME}.mod ${MODULE_NAME}.te &amp;&amp; semodule_package -o ${MODULE_NAME}.pp -m ${MODULE_NAME}.mod</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#000">semodule -i ${MODULE_NAME}.pp</span><span style="color:#f8f8f8;text-decoration:underline">
</span></code></pre></div><p>definition.yaml:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;policy&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">category</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;selinux&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">version</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0.0.1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></code></pre></div><p>Example mypolicy.te (generated with <code>audit2alllow</code>)</p>
<pre><code>#==== cOS SELinux targeted policy module ========
#
# Disclaimer: This module is definition is for illustration use only. It
# has no guarantees of completeness, accuracy and usefulness. It should
# not be used &quot;as is&quot;.
# 


module epinioOS 1.0;

require {
	type init_t;
	type audisp_t;
	type getty_t;
	type unconfined_t;
	type initrc_t;
	type bin_t;
	type tmpfs_t;
	type wicked_t;
	type systemd_logind_t;
	type sshd_t;
	type lib_t;
	type unlabeled_t;
	type chkpwd_t;
	type unconfined_service_t;
	type usr_t;
	type local_login_t;
	type cert_t;
	type system_dbusd_t;
	class lnk_file read;
	class file { execmod getattr open read };
	class dir { getattr read search watch };
}

#============= audisp_t ==============
allow audisp_t tmpfs_t:lnk_file read;

#============= chkpwd_t ==============
allow chkpwd_t tmpfs_t:file { getattr open read };

#============= getty_t ==============
allow getty_t tmpfs_t:file { getattr open read };

#============= init_t ==============
allow init_t cert_t:dir watch;
allow init_t usr_t:dir watch;

#============= initrc_t ==============

#!!!! This avc can be allowed using the boolean 'selinuxuser_execmod'
allow initrc_t bin_t:file execmod;

#============= local_login_t ==============
allow local_login_t tmpfs_t:file { getattr open read };
allow local_login_t tmpfs_t:lnk_file read;

#============= sshd_t ==============
allow sshd_t tmpfs_t:lnk_file read;

#============= system_dbusd_t ==============
allow system_dbusd_t lib_t:dir watch;
allow system_dbusd_t tmpfs_t:lnk_file read;

#============= systemd_logind_t ==============
allow systemd_logind_t unlabeled_t:dir { getattr search };

#============= unconfined_service_t ==============

#!!!! This avc can be allowed using the boolean 'selinuxuser_execmod'
allow unconfined_service_t bin_t:file execmod;

#============= unconfined_t ==============

#!!!! This avc can be allowed using the boolean 'selinuxuser_execmod'
allow unconfined_t bin_t:file execmod;

#============= wicked_t ==============
allow wicked_t tmpfs_t:dir read;
allow wicked_t tmpfs_t:file { getattr open read };
allow wicked_t tmpfs_t:lnk_file read;
</code></pre>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-bd2c7a111cdf07391221b169f69faaa1">3 - Known issues</h1>
    <div class="lead">This document encompasses known issues while building cOS and cOS derivatives.</div>
	<p>When building cOS or a cOS derivative, you could face different issues, this section provides a description of the most known ones, and way to workaround them.</p>
<h3 id="building-selinux-fails">Building SELinux fails</h3>
<p><code>cOS</code> by default has SELinux enabled in permissive mode. If you are building parts of cOS or cOS itself from scratch, you might encounter issues while building the SELinux module, like so:</p>
<pre><code>Step 12/13 : RUN checkmodule -M -m -o cOS.mod cOS.te &amp;&amp; semodule_package -o cOS.pp -m cOS.mod
  ---&gt; Using cache
 ---&gt; 1be520969ead
Step 13/13 : RUN semodule -i cOS.pp
  ---&gt; Running in c5bfa5ae92e2
 libsemanage.semanage_commit_sandbox: Error while renaming /var/lib/selinux/targeted/active to /var/lib/selinux/targeted/previous. (Invalid cross-device link).
semodule:  Failed!
 The command '/bin/sh -c semodule -i cOS.pp' returned a non-zero code: 1
 Error: while resolving join images: failed building join image: Failed compiling system/selinux-policies-0.0.6+3: failed building package image: Could not push image: raccos/sampleos:ffc8618ecbfbffc11cc3bca301cc49867eb7dccb623f951dd92caa10ced29b68 selinux-policies-system-0.0.6+3.dockerfile: Could not build image: raccos/sampleos:ffc8618ecbfbffc11cc3bca301cc49867eb7dccb623f951dd92caa10ced29b68 selinux-policies-system-0.0.6+3.dockerfile: Failed running command: : exit status 1
 Bailing out
make: *** [Makefile:45: build] Error 1
</code></pre><p>The issue is possibly caused by <a href="https://github.com/docker/for-linux/issues/480">https://github.com/docker/for-linux/issues/480</a> . A workaround is to switch the storage driver of Docker. Check if your storage driver is overlay2, and switch it to <code>devicemapper</code></p>
<h3 id="multi-stage-copy-build-fails">Multi-stage copy build fails</h3>
<p>While processing images with several stage copy, you could face the following:</p>
<pre><code> 🐋  Building image raccos/sampleos:cc0aee4ff6c194f920a945c45ebcb487c3e22c5ab40e2634ea70c064dfab206d done
 📦  8/8 system/cos-0.5.3+1 ⤑ 🔨  build system/selinux-policies-0.0.6+3 ✅  Done
 🚀  All dependencies are satisfied, building package requested by the user system/cos-0.5.3+1
 📦  system/cos-0.5.3+1  Using image:  raccos/sampleos:cc0aee4ff6c194f920a945c45ebcb487c3e22c5ab40e2634ea70c064dfab206d
 📦  system/cos-0.5.3+1 🐋  Generating 'builder' image from raccos/sampleos:cc0aee4ff6c194f920a945c45ebcb487c3e22c5ab40e2634ea70c064dfab206d as raccos/sampleos:builder-8533d659df2505a518860bd010b7a8ed with prelude steps
🚧  warning Failed to download 'raccos/sampleos:builder-8533d659df2505a518860bd010b7a8ed'. Will keep going and build the image unless you use --fatal
🚧  warning Failed pulling image: Error response from daemon: manifest for raccos/sampleos:builder-8533d659df2505a518860bd010b7a8ed not found: manifest unknown: manifest unknown
: exit status 1
 🐋  Building image raccos/sampleos:builder-8533d659df2505a518860bd010b7a8ed
 Sending build context to Docker daemon  9.728kB
 Step 1/10 : FROM raccos/sampleos:cc0aee4ff6c194f920a945c45ebcb487c3e22c5ab40e2634ea70c064dfab206d
  ---&gt; f1122e79b17e
Step 2/10 : COPY . /luetbuild
  ---&gt; 4ff3e202951b
 Step 3/10 : WORKDIR /luetbuild
  ---&gt; Running in 7ec571b96c6f
 Removing intermediate container 7ec571b96c6f
  ---&gt; 9e05366f830a
Step 4/10 : ENV PACKAGE_NAME=cos
  ---&gt; Running in 30297dbd21a3
 Removing intermediate container 30297dbd21a3
  ---&gt; 4c4838b629f4
 Step 5/10 : ENV PACKAGE_VERSION=0.5.3+1
  ---&gt; Running in 36361b617252
 Removing intermediate container 36361b617252
  ---&gt; 6ac0d3a2ff9a
Step 6/10 : ENV PACKAGE_CATEGORY=system
  ---&gt; Running in f20c2cf3cf34
 Removing intermediate container f20c2cf3cf34
  ---&gt; a902ff95d273
 Step 7/10 : COPY --from=quay.io/costoolkit/build-cache:f3a333095d9915dc17d7f0f5629a638a7571a01dcf84886b48c7b2e5289a668a /usr/bin/yip /usr/bin/yip
  ---&gt; 42fa00d9c990
 Step 8/10 : COPY --from=quay.io/costoolkit/build-cache:e3bbe48c6d57b93599e592c5540ee4ca7916158461773916ce71ef72f30abdd1 /usr/bin/luet /usr/bin/luet
 e3bbe48c6d57b93599e592c5540ee4ca7916158461773916ce71ef72f30abdd1: Pulling from costoolkit/build-cache
 3599716b36e7:  Already exists
 24a39c0e5d06: Already exists
 4f4fb700ef54: Already exists
 4f4fb700ef54: Already exists
 4f4fb700ef54: Already exists
 378615c429f5: Already exists
 c28da22d3dfd:  Already exists
 ddb4dd5c81b0: Already exists
 92db41c0c9ab: Already exists
 4f4fb700ef54: Already exists
 6e0ca71a6514: Already exists
 47debb886c7d: Already exists
 4f4fb700ef54: Already exists
 4f4fb700ef54: Already exists
 4f4fb700ef54: Already exists
 d0c9d0f8ddb6: Already exists
 e5a48f1f72ad:  Pulling fs layer
 4f4fb700ef54:  Pulling fs layer
 7d603b2e4a37:  Pulling fs layer
 64c4d787e344:  Pulling fs layer
 f8835d2e60d1:  Pulling fs layer
 64c4d787e344:  Waiting
 f8835d2e60d1:  Waiting
 e5a48f1f72ad:  Download complete
 e5a48f1f72ad:  Pull complete
 4f4fb700ef54:  Verifying Checksum
 4f4fb700ef54:  Download complete
 4f4fb700ef54:  Pull complete
 7d603b2e4a37: Verifying Checksum
7d603b2e4a37: Download complete
 64c4d787e344: Verifying Checksum
64c4d787e344: Download complete
 7d603b2e4a37: Pull complete
 64c4d787e344: Pull complete
 f8835d2e60d1:  Verifying Checksum
 f8835d2e60d1:  Download complete
 f8835d2e60d1: Pull complete
 Digest: sha256:9b58bed47ff53f2d6cc517a21449cae686db387d171099a4a3145c8a47e6a1e0
 Status: Downloaded newer image for quay.io/costoolkit/build-cache:e3bbe48c6d57b93599e592c5540ee4ca7916158461773916ce71ef72f30abdd1
 failed to export image: failed to create image: failed to get layer sha256:118537d8997a08750ab1ac3d8e8575e40fe60e8337e02633b0d8a1287117fe78: layer does not exist
 Error: while resolving join images: failed building join image: failed building package image: Could not push image: raccos/sampleos:cc0aee4ff6c194f920a945c45ebcb487c3e22c5ab40e2634ea70c064dfab206d cos-system-0.5.3+1-builder.dockerfile: Could not build image: raccos/sampleos:cc0aee4ff6c194f920a945c45ebcb487c3e22c5ab40e2634ea70c064dfab206d cos-system-0.5.3+1-builder.dockerfile: Failed running command: : exit status 1
 Bailing out
make: *** [Makefile:45: build] Error 1
</code></pre><p>There is a issue open <a href="https://github.com/moby/moby/issues/37965">upstream</a> about it. A workaround is to enable Docker buildkit with <code>DOCKER_BUILDKIT=1</code>.</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-64cdd9f4dae5e1e36b28a390789e7b34">4 - Runtime layout</h1>
    <div class="lead">Runtime layout of a booted cOS derivative</div>
	<p>This section describes the runtime layout of a derivative (or a cOS Vanilla image) once booted in a system.</p>
<p>The cOS toolkit performs during installation a common setup which is equivalent across all derivatives.</p>
<p>This mechanism ensures that a layout:</p>
<ul>
<li>it&rsquo;s simple and human friendly</li>
<li>allows to switch easily derivatives</li>
<li>allows to perform recovery tasks</li>
<li>is resilient to upgrade failures</li>
</ul>
<h2 id="layout">Layout</h2>
<p>The basic setup consists of:</p>
<ul>
<li>an <code>A/B</code> partitioning style. We have an &lsquo;active&rsquo; and a &lsquo;passive&rsquo; system too boot from in case of failures</li>
<li>a Recovery system which allows to perform emergency tasks in case of failure of the &lsquo;A/B&rsquo; partitions</li>
<li>a Fallback mechanism that boots the partitions in this sequence: &ldquo;A -&gt; B -&gt; Recovery&rdquo; in case of booting failures</li>
</ul>
<p>The upgrade happens in a transition image and take places only after all the necessary steps are completed. An upgrade of the &lsquo;A/B&rsquo; partitions can be done by booting into them and running <code>elemental upgrade</code>. This will create a new pristine image that will be selected as active for the next reboot, the old one will be flagged as passive. If we are performing the same from the passive system, only the active is subject to changes.</p>
<p>Similarly, a recovery system can be upgraded as well by running <code>elemental upgrade --recovery</code>. This will upgrade the recovery system instead of the active/passive. Note both commands needs to be run inside the active or passive system.</p>
<h2 id="partitions">Partitions</h2>
<p><img src="https://docs.google.com/drawings/d/e/2PACX-1vSP-Pz9l9hwYDeIlej7qXzzcMzGYBiKjyFpiYYKlbNR3H37n_R_c0eBNeYa3msouOupmDim3ZYYBSxS/pub?w=812&amp;h=646" alt=""></p>
<p>The default partitioning is created during installation and is expected to be present in a booted cOS system:</p>
<ul>
<li>a <code>COS_STATE</code> partition that will contain our active, passive and recovery images. The images are located under the <code>/cOS</code> directory</li>
<li>a <code>COS_PERSISTENT</code> partition which contains the persistent user data. This directory is mounted over <code>/usr/local</code> during runtime</li>
<li>a <code>COS_OEM</code> partition which contains the cloud-init oem files, which is mounted over <code>/oem</code> during runtime</li>
<li>a <code>COS_RECOVERY</code> partition which contains the recovery system image</li>
</ul>
<p>The <code>COS_STATE</code> partitions contains the <code>active</code>, <code>passive</code> . While the <code>active</code> and <code>passive</code> are <code>.img</code> files which are loopback mounted, the <code>recovery</code> system is in <code>COS_RECOVERY</code> and can also be a <code>squashfs</code> file (provided in <code>/cOS/recovery.squashfs</code>). This ensures the immutability aspect and ease out building derivative in constrained environments (e.g. when we have restricted permissions and we can&rsquo;t mount).</p>
<p>For more information about the immutability aspect of cOS, see <a href="../immutable_rootfs">Immutable rootfs</a></p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-cf896bdd96bc95a1c5079a49e2dd0b00">5 - Immutable Root Filesystem</h1>
    <div class="lead">Immutable root filesystem configuration parameters</div>
	<p>The immutable rootfs concept in cOS is provided by a dracut module which is
basically the contents of the <a href="../../reference/packages/system-immutable-rootfs">immutable-rootfs</a> package provided as part
of the cOS repository tree.</p>
<p>By default, <code>cos</code> and derivatives will inherit an immutable setup.</p>
<p><img src="https://docs.google.com/drawings/d/e/2PACX-1vR-I5ZwwB5EjpsymUfcNADRTTKXrNMnlZHgD8RjDpzYhyYiz_JrWJwvpcfMcwfYet1oWCZVWH22aj1k/pub?w=533&amp;h=443" alt="Partitioning layout"></p>
<p>A running system will look like as follows:</p>
<pre><code>/usr/local - persistent (COS_PERSISTENT)
/oem - persistent (COS_OEM)
/etc - ephemeral
/usr - read only
/ immutable
</code></pre><p>This means that any changes that are not specified as cloud-init configuration are not persisting across reboots.</p>
<p>You can place persisting cloud-init files either in <code>/oem</code> or <code>/usr/local/oem</code>, <code>cOS</code> already supports cloud-init <a href="https://cloudinit.readthedocs.io/en/latest/topics/datasources.html">datasources</a>, so you can use also load cloud-init configuration as standard userdata, depending on the platform. For more details on the cloud-init syntax, see the <a href="../reference/cloud_init">cloud-init configuration reference</a>.</p>


<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Note</h4>

    You can check the package <a href="../../reference/packages/system-immutable-rootfs">documentation reference</a> for a detailed explaination of the configuration and how to override default settings. Immutability, as of other aspects, can be disabled.

</div>


</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-071ba6d3efabf269c535d8df6613a33c">6 - Package reference documentation</h1>
    <div class="lead">This section contains documentation for core packages present in the cOS toolkit repositories</div>
	<p>There are a set of core packages available in the cOS repositories which are installable with <code>luet</code> while creating a derivative in the Dockerfile. Those bring in new features, enhancements and core features of the cOS toolkit. Some are optional (like runtime features) while some of them are strictly necessary in order for a cOS system to boot and operate correctly.</p>
<p>This section contains reference documentation specific to core packages in the cOS repositories and the functionalities they bring.</p>
<p>All the packages available can also be browsed <a href="https://rancher-sandbox.github.io/cos-toolkit-package-browser/">here</a>.</p>

</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-6a3ead1af1706490161648c4b6020882">6.1 - Cloud config packages</h1>
    <div class="lead">Cloud config packages are collection of cloud-config file which extends a cOS derivative</div>
	<p>Several default cloud config are present in the cOS repositories. They can be all pulled with the <code>system/cloud-config</code> package or individually ( <code>cloud-config/&lt;package&gt;</code> ).</p>
<p>Each one of them bring a separate functionality or extend the system. For example, the <code>networking</code> cloud-config provides a basic networking setting for <code>wicked</code>, or <code>cloud-config/rootfs</code> provides a basic cOS default rootfs layout configuration.</p>

</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-f2ca177fa7c53b8937746af159835536">6.1.1 - cloud-config/boot-assessment</h1>
    <div class="lead">Documentation for the cloud-config/boot-assessment package</div>
	<p>

<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Note</h4>

    <p><a href="https://rancher-sandbox.github.io/cos-toolkit-package-browser/find/cloud-config/boot-assessment" class="btn btn-sm position-relative rounded-pill bg-light text-dark"
role="button">
<i class='fa fa-box'></i> cloud-config/boot-assessment
</a>
is part of the cOS toolkit repository and can be installed with:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">luet install -y cloud-config/boot-assessment
</code></pre></div><p>in the derivative&rsquo;s Dockerfile.</p>


</div>

In order for a derivative to enable boot assessment, it is only required to have the cloud-config file installed.</p>
<p>The boot assessment process works in the following way:</p>
<ul>
<li>After an upgrade, sets a GRUB env sentinel variable indicating that we did run an upgrade</li>
<li>At the first boot, if we an upgrade was attempted, we set another sentinel variable, which indicates a booting attempt
<ul>
<li>If we boot fine, sentinels are removed</li>
<li>If we get back again at the GRUB menu, a failure must have occurred and we select the fallback entry, creating also
sentinels files and a specific cmdline option indicating we failed booting after an upgrade</li>
</ul>
</li>
</ul>
<p>The grub sentinel files are in the COS_STATE partition, and get installed automatically after reset, install and upgrade:</p>
<ul>
<li><code>/boot_assessment</code> - contains the GRUB env sentinel variables</li>
<li><code>/grub_boot_assessment</code> - contains the GRUB logic for booting into fallback</li>
</ul>
<p>Note: The extra GRUB logic is installed and sourced into <code>/grubcustom</code> inside <code>COS_STATE</code>.</p>
<p>When a boot failure is detected and the fallback is automatically selected, it will be created a <code>/run/cos/upgrade_failure</code> sentinel file during the boot process, which is accessible under the <code>boot</code> cloud-init stage.</p>
<p>To enable boot assessment besides upgrades, <code>enable_boot_assessment_always</code> can be set to <code>yes</code> in the grub environment ( for example in <code>/oem/grubenv</code> ).</p>
<h2 id="manually-enabling-boot-assessment">Manually enabling boot assessment</h2>
<p>To manually trigger the boot assessment for the next boot, you can run the following in a active/passive booted system:</p>
<pre><code>sudo mount -o rw,remount /run/initramfs/cos-state
grub2-editenv /run/initramfs/cos-state/boot_assessment set enable_boot_assessment=yes
sudo mount -o ro,remount /run/initramfs/cos-state
</code></pre><h2 id="maintenance">Maintenance</h2>
<p>If the active partition fails, the boot assessment process will bring you back to the fallback partition. This is also the case if the dracut shell is displayed while dropping in emergency mode.</p>
<p>If you are planning to do manual intervention and want to hook up with that console, you can disable the boot assessment process by running in the fallback partition:</p>
<pre><code>sudo mount -o rw,remount /run/initramfs/cos-state
grub2-editenv /run/initramfs/cos-state/boot_assessment set enable_boot_assessment=
grub2-editenv /run/initramfs/cos-state/boot_assessment set boot_assessment_tentative=
sudo mount -o ro,remount /run/initramfs/cos-state
</code></pre>
</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-f88126e2014aaca7f42ad5e31b8a017a">6.2 - GRUB</h1>
    <div class="lead">Packages collection that contains GRUB configuration and artifacts</div>
	<p>This collection contains GRUB2 configurations and related installation artifacts.</p>
<ul>
<li><code>system/grub2-efi-image</code> ships a generic efi image for the repository platform</li>
<li><code>system/grub2-artifacts</code> ships grub files which typically are installed into the GRUB partition</li>
<li><code>ststem/grub2-config</code> ships default cOS GRUB configuration file</li>
</ul>

</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-38a488e2fb8d5af933f04fa04ae06c0f">6.3 - Meta packages</h1>
    <div class="lead">Meta packages are collection of packages, like bundles, which installs a collection of sub-packages</div>
	<p>In the <code>cOS</code> repository are present meta packages that are collection of packages which are suitable for different needs.</p>
<p>We can compare them to <code>bundles</code> which pulls in during installation sub-packages which should be installed in the system target.</p>
<p>For example, we have <code>cos-minimal</code> and <code>cos-core</code>: <code>cos-core</code> is the minimum required of packages in order for having a working <code>cOS</code> derivative, while <code>cos-minimal</code> have additional <code>cloud-init</code> configurations that allows a system in order to boot properly.</p>

</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-2ee14c4414706eb4e3550293ae147e56">6.3.1 - meta/cos-core</h1>
    <div class="lead">Documentation for the meta/cos-core package</div>
	<p>

<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Note</h4>

    <p><a href="https://rancher-sandbox.github.io/cos-toolkit-package-browser/find/meta/cos-core" class="btn btn-sm position-relative rounded-pill bg-light text-dark"
role="button">
<i class='fa fa-box'></i> meta/cos-core
</a>
is part of the cOS toolkit repository and can be installed with:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">luet install -y meta/cos-core
</code></pre></div><p>in the derivative&rsquo;s Dockerfile.</p>


</div>

<code>cos-core</code> is a meta collection which pulls the <code>toolchain</code> (<code>elemental-cli</code> and <code>luet</code>) and the <code>cos</code> modules (<code>installer</code>,<code>cos-setup</code>, <code>immutable-rootfs</code>, <code>base-dracut-modules</code> and <code>grub2-config</code>).</p>
<p>A <code>meta/cos-core-fips</code> variant is available to pull the toolchain compiled with fips enabled.</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-20f0dfa30c6acbc13f3bda70a14963b6">6.3.2 - meta/cos-minimal</h1>
    <div class="lead">Documentation for the meta/cos-minimal package</div>
	<p>

<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Note</h4>

    <p><a href="https://rancher-sandbox.github.io/cos-toolkit-package-browser/find/meta/cos-minimal" class="btn btn-sm position-relative rounded-pill bg-light text-dark"
role="button">
<i class='fa fa-box'></i> meta/cos-minimal
</a>
is part of the cOS toolkit repository and can be installed with:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">luet install -y meta/cos-minimal
</code></pre></div><p>in the derivative&rsquo;s Dockerfile.</p>


</div>

This meta collection includes the <code>cos-core</code> collection and additionally a set of default <code>cloud-config</code> files installed in <code>/system/oem</code>. The cloud-config files are setting defaults for upgrades, system user and password, default network setup and the immutability layer.</p>
<p>A <code>meta/cos-minimal-fips</code> variant is available to pull the toolchain compiled with fips enabled.</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-936dc212b34efd945dfb5c1c8055923d">6.3.3 - meta/cos-modules</h1>
    <div class="lead">Documentation for the meta/cos-modules package</div>
	<p>

<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Note</h4>

    <p><a href="https://rancher-sandbox.github.io/cos-toolkit-package-browser/find/meta/cos-modules" class="btn btn-sm position-relative rounded-pill bg-light text-dark"
role="button">
<i class='fa fa-box'></i> meta/cos-modules
</a>
is part of the cOS toolkit repository and can be installed with:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">luet install -y meta/cos-modules
</code></pre></div><p>in the derivative&rsquo;s Dockerfile.</p>


</div>

The <code>cos</code> modules pulls the following packages:</p>
<ul>
<li><code>installer</code> (which ships <code>cos-installer</code>, <code>cos-upgrade</code>, <code>cos-reset</code> etc. )</li>
<li><code>cos-setup</code> (which ships the system config services for systemctl)</li>
<li><code>immutable-rootfs</code> (dracut modules)</li>
<li><code>base-dracut-modules</code> and <code>grub2-config</code> (dracut and grub2 configuration)</li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-cd398c4a96ce6315b3ed8413b9677a10">6.3.4 - meta/cos-verify</h1>
    <div class="lead">Documentation for the meta/cos-verify package</div>
	<p>

<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Note</h4>

    <p><a href="https://rancher-sandbox.github.io/cos-toolkit-package-browser/find/meta/cos-verify" class="btn btn-sm position-relative rounded-pill bg-light text-dark"
role="button">
<i class='fa fa-box'></i> meta/cos-verify
</a>
is part of the cOS toolkit repository and can be installed with:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">luet install -y meta/cos-verify
</code></pre></div><p>in the derivative&rsquo;s Dockerfile.</p>


</div>

The <code>cos-verify</code> meta package pulls <code>cosign</code> and the <code>luet-cosign</code> plugin to enable container image signature verification.</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-2d0403630e1a722c86e82297c9ab7b8b">6.3.5 - meta/toolchain</h1>
    <div class="lead">Documentation for the meta/toolchain package</div>
	<p>

<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Note</h4>

    <p><a href="https://rancher-sandbox.github.io/cos-toolkit-package-browser/find/meta/toolchain" class="btn btn-sm position-relative rounded-pill bg-light text-dark"
role="button">
<i class='fa fa-box'></i> meta/toolchain
</a>
is part of the cOS toolkit repository and can be installed with:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">luet install -y meta/toolchain
</code></pre></div><p>in the derivative&rsquo;s Dockerfile.</p>


</div>

A meta package for <code>luet</code> and <code>elemental-cli</code>.</p>

</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-814d9b5826621eca5843f5b6b91b4244">6.4 - system/cos-wrapper</h1>
    <div class="lead">Documentation for the system/cos-wrapper package</div>
	<p>

<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Note</h4>

    <p><a href="https://rancher-sandbox.github.io/cos-toolkit-package-browser/find/system/cos-wrapper" class="btn btn-sm position-relative rounded-pill bg-light text-dark"
role="button">
<i class='fa fa-box'></i> system/cos-wrapper
</a>
is part of the cOS toolkit repository and can be installed with:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">luet install -y system/cos-wrapper
</code></pre></div><p>in the derivative&rsquo;s Dockerfile.</p>


</div>

This package provides the following wrappers around <code>cos-*</code> binaries to facilitate transitioning to the elemental cli:</p>
<ul>
<li><code>cos-installer</code> ( wrapper of <code>elemental install</code> )</li>
<li><code>cos-deploy</code> ( wrapper of <code>elemental reset</code> )</li>
<li><code>cos-reset</code> ( wrapper of <code>elemental reset</code> )</li>
<li><code>cos-upgrade</code> ( wrapper of <code>elemental upgrade</code> )</li>
<li><code>suc-upgrade</code> ( wrapper of <code>elemental upgrade</code> )</li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-0e1e2a51c8326695b76478a4bbcb1f0f">6.5 - system/dracut-initrd</h1>
    <div class="lead">Documentation for the system/dracut-initrd package</div>
	<p>

<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Note</h4>

    <p><a href="https://rancher-sandbox.github.io/cos-toolkit-package-browser/find/system/dracut-initrd" class="btn btn-sm position-relative rounded-pill bg-light text-dark"
role="button">
<i class='fa fa-box'></i> system/dracut-initrd
</a>
is part of the cOS toolkit repository and can be installed with:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">luet install -y system/dracut-initrd
</code></pre></div><p>in the derivative&rsquo;s Dockerfile.</p>


</div>

This package provides an initrd generated by dracut which should be suitable for generic machines.</p>
<p>In cases where Derivative wish to re-use the same initrd and kernel from <code>cOS</code> vanilla images, this package can be used in conjuction with <code>system/kernel</code>.</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-b1dbc1c48316ba68af1f8b953282ae48">6.6 - system/immutable-rootfs</h1>
    <div class="lead">Documentation for the system/immutable-rootfs package</div>
	<p>

<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Note</h4>

    <p><a href="https://rancher-sandbox.github.io/cos-toolkit-package-browser/find/system/immutable-rootfs" class="btn btn-sm position-relative rounded-pill bg-light text-dark"
role="button">
<i class='fa fa-box'></i> system/immutable-rootfs
</a>
is part of the cOS toolkit repository and can be installed with:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">luet install -y system/immutable-rootfs
</code></pre></div><p>in the derivative&rsquo;s Dockerfile.</p>


</div>

This package ships the <code>immutable-rootfs</code> dracut module responsible of mounting the root tree during
boot time with the immutable specific setup. The immutability concept refers
to read only root (<code>/</code>) system. To ensure the linux OS is still functional
certain paths or areas are required to be writable, in those cases an
ephemeral overaly tmpfs is set in place. Additionaly, the immutable rootfs
module can also mount a custom list of device blocks with read write
permissions, those are mostly devoted to store persistent data.</p>
<p>The dracut module is mostly configured via kernel command line parameters or
via the <code>/run/cos/cos-layout.env</code> environment file.</p>
<p>These are the read write paths the module mounts as part of the overlay
ephemeral tmpfs: <code>/etc</code>, <code>/root</code>, <code>/home</code>, <code>/opt</code>, <code>/srv</code>, <code>/usr/local</code>
and <code>/var</code>.</p>
<p>These paths will be all ephemeral unless there is a block device configured
to be mounted in the same path.</p>
<p>It is important to remark all the immutable root configuration is applied
in initrd before switching root and after <code>rootfs</code> cloud-init stage but
before <code>initramfs</code> stage. So immutable rootfs configuration via cloud-init
using the <code>/run/cos/cos-layout.env</code> file is only effective if called in any
of the <code>rootfs.before</code>, <code>rootfs</code> or <code>rootfs.after</code> cloud-init stages.</p>
<h2 id="kernel-configuraton-paramters">Kernel configuraton paramters</h2>
<p>The immutable rootfs can be configured witht he following kernel parameters:</p>
<ul>
<li>
<p><code>cos-img/filename=&lt;imgfile&gt;</code>: This is one of the main parameters, it defines
the location of the image file to boot from.</p>
</li>
<li>
<p><code>rd.cos.overlay=tmpfs:&lt;size&gt;</code>: This defines the size of the tmpfs used for
the ephemeral overlayfs. It can be expressed in MiB or as a % of the available
memory. Defaults to <code>rd.cos.overlay=tmpfs:20%</code> if not present.</p>
</li>
<li>
<p><code>rd.cos.overlay=LABEL=&lt;vol_label&gt;</code>: Optionally and mostly for debugging
purposes the overlayfs can be mounted on top of a persistent block device.
Block devices can be expressed by LABEL (<code>LABEL=&lt;blk_label&gt;</code>) or by UUID
(<code>UUID=&lt;blk_uuid&gt;</code>)</p>
</li>
<li>
<p><code>rd.cos.mount=LABEL:&lt;blk_label&gt;:&lt;mountpoint&gt;</code>: This option defines a
persistent block device and its mountpoint. Block devices can also be
defined by UUID (<code>UUID=&lt;blk_uuid&gt;:&lt;mountpoint&gt;</code>). This option can be passed
multiple times.</p>
</li>
<li>
<p><code>rd.cos.oemtimeout=&lt;seconds&gt;</code>: cOS by default assumes the existence of a
persistent block device labelled <code>COS_OEM</code> which is used to keep some
configuration data (mostly cloud-init files). The immutable rootfs tries
to mount this device at very early stages of the boot even before applying
the immutable rootfs configs. It done this way to enable to configure the
immutable rootfs module within the cloud-init files. As the <code>COS_OEM</code> device
might not be always present the boot process just continues without failing
after a certain timeout. This option configures such a timeout. Defaults to
10s.</p>
</li>
<li>
<p><code>rd.cos.debugrw</code>: This is a boolean option, true if present, false if not.
This option sets the root image to be mounted as a writable device. Note this
completely breaks the concept of an immutable root. This is helpful for
debugging or testing purposes, so changes persist across reboots.</p>
</li>
<li>
<p><code>rd.cos.disable</code>: This is a boolean option, true if present, false if not.
It disables the execution of any immutable rootfs module logic at boot.</p>
</li>
</ul>
<h3 id="configuration-with-an-environment-file">Configuration with an environment file</h3>
<p>The immutable rootfs can be configured with the <code>/run/cos/cos-layout.env</code>
environment file. It is important to note that all the immutable root
configuration is applied in initrd before switching root and after
<code>rootfs</code> cloud-init stage but before <code>initramfs</code> stage. So immutable rootfs
configuration via cloud-init using the <code>/run/cos/cos-layout.env</code> file is
only effective if called in any of the <code>rootfs.before</code>, <code>rootfs</code> or
<code>rootfs.after</code> cloud-init stages.</p>
<p>In the environment file few options are available:</p>
<ul>
<li>
<p><code>VOLUMES=LABEL=&lt;blk_label&gt;:&lt;mountpoint&gt;</code>: This variable expects a block device
and it mountpoint pair space separated list. The default cOS configuration is:</p>
<p><code>VOLUMES=&quot;LABEL=COS_OEM:/oem LABEL=COS_PERSISTENT:/usr/local&quot;</code></p>
</li>
<li>
<p><code>OVERLAY</code>: It defines the underlaying device for the overlayfs as in
<code>rd.cos.overlay=</code> kernel parameter.</p>
</li>
<li>
<p><code>DEBUGRW=true</code>: Sets the root (<code>/</code>) to be mounted with read/write permissions.</p>
</li>
<li>
<p><code>MERGE=true</code>: Sets makes the <code>VOLUMES</code> values to be merged with any other
volume that might have been defined in the kernel command line. The merging
criteria is simple: any overlapping volume is overwritten all others are
appended to whatever was already defined as a kernel parameter. If not
defined defaults to <code>true</code>.</p>
</li>
<li>
<p><code>RW_PATHS</code>: This is a space separated list of paths. These are the paths
that will be used for the ephemeral overlayfs. These are the paths that
will be mounted as overlay on top of the <code>OVERLAY</code> (or <code>rd.cos.overlay</code>)
device. Default value is:</p>
<p><code>RW_PATHS=&quot;/etc /root /home /opt /srv /usr/local /var&quot;</code>
<strong>Note</strong>: as those paths are overlayed with an ephemeral mount (<code>tmpfs</code>),
additional data wrote on those location won&rsquo;t be available on subsequent boots.</p>
</li>
<li>
<p><code>PERSISTENT_STATE_TARGET</code>: This is the folder where the persistent state data
will be stored, if any. Default value is <code>/usr/local/.state</code>.</p>
</li>
<li>
<p><code>PERSISTENT_STATE_PATHS</code>: This is a space separated list of paths. These are
the paths that will become writable and store its data inside
<code>PERSISTENT_STATE_TARGET</code>. By default this variable is empty, which means
no persistent state area is created or used.</p>
<p><strong>Note</strong>: The specified paths needs either to exist or be located in an area
which is writeable ( for example, inside locations specified with <code>RW_PATHS</code>).
The dracut module will attempt to create non-existant directories,
but might fail if the mountpoint where are located is read-only.</p>
</li>
<li>
<p><code>PERSISTENT_STATE_BIND=&quot;true|false&quot;</code>: When this variable is set to true
the persistent state paths are bind mounted (instead of using overlayfs)
after being mirrored with the original content. By default this variable is
set to <code>false</code>.</p>
</li>
</ul>
<p>Note that persistent state are is setup once the ephemeral paths and persistent
volumes are mounted. Persistent state paths can&rsquo;t be an already existing mount
point. If the persistent state requires any of the paths that are part of the
ephemeral area by default, then <code>RW_PATHS</code> needs to be defined to avoid
overlapping paths.</p>
<p>For exmaple a common cOS configuration can be expressed as part of the
cloud-init configuration as follows:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">example</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">stage</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">rootfs</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;Layout configuration&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">environment_file</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">/run/cos/cos-layout.env</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">environment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">VOLUMES</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;LABEL=COS_OEM:/oem LABEL=COS_PERSISTENT:/usr/local&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">OVERLAY</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;tmpfs:25%&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-963179f6f5bbd1cd10ee6ac9f8a021f8">6.7 - utils/installer</h1>
    <div class="lead">Documentation for the utils/installer package</div>
	<p>

<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Note</h4>

    <p><a href="https://rancher-sandbox.github.io/cos-toolkit-package-browser/find/utils/installer" class="btn btn-sm position-relative rounded-pill bg-light text-dark"
role="button">
<i class='fa fa-box'></i> utils/installer
</a>
is part of the cOS toolkit repository and can be installed with:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">luet install -y utils/installer
</code></pre></div><p>in the derivative&rsquo;s Dockerfile.</p>


</div>

This package provides the following utilities:</p>
<ul>
<li><code>cos-installer</code> ( wrapper of <code>cos --install</code> )</li>
<li><code>cos-deploy</code> ( wrapper of <code>elemental install</code> )</li>
<li><code>cos-reset</code> ( wrapper of <code>elemental reset</code> )</li>
<li><code>cos-rebrand</code> ( wrapper of <code>cos --rebrand</code> )</li>
<li><code>cos-upgrade</code> ( wrapper of <code>elemental upgrade</code> )</li>
<li><code>suc-upgrade</code> ( wrapper of <code>cos --upgrade</code> )</li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-b776ece418034168ac1443ec311f82df">6.8 - system/kernel</h1>
    <div class="lead">Documentation for the system/kernel package</div>
	<p>

<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Note</h4>

    <p><a href="https://rancher-sandbox.github.io/cos-toolkit-package-browser/find/system/kernel" class="btn btn-sm position-relative rounded-pill bg-light text-dark"
role="button">
<i class='fa fa-box'></i> system/kernel
</a>
is part of the cOS toolkit repository and can be installed with:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">luet install -y system/kernel
</code></pre></div><p>in the derivative&rsquo;s Dockerfile.</p>


</div>

This package provides the default distribution kernel which should be suitable for generic machines.</p>
<p>In cases where Derivative wish to re-use the same initrd and kernel from <code>cOS</code> vanilla images, this package can be used in conjuction with <code>system/dracut-initrd</code>.</p>

</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-96caa056902ceb82a4f9a52e36852e8c">7 - Troubleshooting</h1>
    <div class="lead">Stuff can go wrong. This document tries to make them right with some useful tips</div>
	

<div class="pageinfo pageinfo-warning">
<p>Section under construction.</p>

</div>

<p>While building a derivative, or on a running system things can go really wrong, the guide is aimed to give tips while building derivatives and also debugging running systems.</p>
<p>Don&rsquo;t forget tocheck the known issues for the <a href="https://github.com/rancher-sandbox/cOS-toolkit/issues">release you&rsquo;re using</a>.</p>
<p>Before booting, <a href="../immutable_rootfs">several kernel parameters</a> can be used to help during debugging (also when booting an ISO). Those are meant to be used only while debugging, and they might defeat the concept of immutability.</p>
<h2 id="disable-immutability">Disable Immutability</h2>
<p>By adding <code>rd.cos.debugrw</code> to the boot parameters read only mode will be disabled. See <a href="../immutable_rootfs">Immutable setup</a> for more options.</p>
<p>The derivative will boot into RW mode, that means any change made during runtime will persist across reboots. Use this feature with caution as defeats the concept of immutability.</p>
<p><code>rd.cos.debugrw</code> applies only to active and passive partitions. The recovery image can&rsquo;t be mutated.</p>


<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Note</h4>

    The changes made will persist during reboots but won&rsquo;t persist across upgrades. If you need to persist changes across upgrades in runtime (for example by adding additional packages on top of the derivative image), see <a href="../../customizing/runtime_persistent_changes">how to apply persistent changes</a>.

</div>

<h2 id="debug-initramfs-issues">Debug initramfs issues</h2>
<p>As derivative can ship and build their own initrd, the <a href="https://fedoraproject.org/wiki/How_to_debug_Dracut_problems">official debug docs</a> contains valid information that can be used for troubleshooting.</p>
<p>For example:</p>
<ul>
<li><code>rd.break=pre-mount rd.shell</code>: Drop a shell before setting up mount points</li>
<li><code>rd.break=pre-pivot rd.shell</code>: Drop a shell before switch-root</li>
</ul>
<h2 id="recovery-partition">Recovery partition</h2>
<p>If you can boot into the system, the recovery partition can be used to reset the state of the active/passive, but can also be used to upgrade to specific images. Be sure to read the <a href="../../getting-started/recovery">Recovery section in the docs</a>.</p>
<h2 id="mutating-derivative-images">Mutating derivative images</h2>
<p>It can be useful to mutate derivative images and commit a container’s file changes or settings into a new image.
This allows you to debug a container by running an interactive shell, and re-use the mutated image in cOS systems. Generally, it is better to use Dockerfiles to manage your images in a documented and maintainable way. <a href="../../creating-derivatives/creating_bootable_images">Read more about creating bootable images</a>.</p>
<p>Let&rsquo;s suppose we have the derivative original image at <code>$IMAGE</code> and we want to mutate it. We will push it later with another name <code>$NEW_IMAGE</code> and use it to our node downstream.</p>
<p>Run the derivative image locally, and perform any necessary change (e.g. add additional software):</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$&gt; docker run --entrypoint /bin/bash -ti --name updated-image <span style="color:#000">$IMAGE</span>
</code></pre></div><p>Commit any changes to a new image <code>$NEW_IMAGE</code>:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$&gt; docker commit updated-image <span style="color:#000">$NEW_IMAGE</span>
</code></pre></div><p>And push the image to the container registry:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$&gt; docker push <span style="color:#000">$NEW_IMAGE</span>
</code></pre></div><p>In the derivative then it&rsquo;s sufficient to upgrade to that image with <code>elemental upgrade</code>:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$&gt; elemental upgrade --no-verify --docker-image <span style="color:#000">$NEW_IMAGE</span>
</code></pre></div><h2 id="adding-login-keys-at-boot">Adding login keys at boot</h2>
<p>To add users key from the GRUB menu prompt, edit the boot cmdline and add the following kernel parameters:</p>
<p><code>stages.boot[0].authorized_keys.root[0]=github:mudler</code></p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-52dc75d922e47809f6e4b3a9ac43e7a8">8 - High level architecture</h1>
    <div class="lead">High level architecture of cOS and its components.</div>
	<h1 id="cos-toolkit-high-level-architecture">cOS toolkit High level Architecture</h1>
<p>This page tries to encompass the <a href="https://github.com/rancher-sandbox/cOS-toolkit"><code>cos-toolkit</code></a> structure and the high level architecture, along with all the involved components.</p>
<h2 id="design-goals">Design goals</h2>
<ul>
<li>Blueprints to build immutable Linux derivatives from container images</li>
<li>A workflow to maintain, support and deliver custom-OS and upgrades to end systems</li>
<li>Derivatives have the same “foundation” manifest - easy to customize on top, add packages: <code>systemd</code>, <code>dracut</code> and <code>grub</code> as a foundation stack.</li>
<li>Upgrades delivered with container registry images ( also workflow with <code>docker run</code> &amp;&amp; <code>docker commit</code> supported! )
<br/>The content of the container image is the system which is booted.</li>
</ul>
<h2 id="high-level-overview">High level overview</h2>
<p>cOS-Toolkit encompasses several components required for building and distributing OS images. <a href="https://github.com/rancher-sandbox/cOS-toolkit/issues/108">This issue</a> summarize the current state, and how we plan to integrate them in a single CLI to improve the user experience.</p>
<p>cOS-Toolkit is also a manifest, which includes package definitions of how the underlying OS is composed. It forms an abstraction layer, which is then translated to Dockerfiles and built by our CI (optionally) for re-usal. A derivative can be built by parts of the manifest, or reusing it entirely, container images included.</p>
<p><img src="https://docs.google.com/drawings/d/e/2PACX-1vQQJOaISPbMxMYU44UT-M3ou9uGYOrzbXCRXMLPU8m7_ie3ke_08xCsyRLkFZJRB4VnzIeobPciEoQv/pub?w=942&amp;h=532" alt="High level overview"></p>
<p>The fundamental phases can be summarized in the following steps:</p>
<ul>
<li>Build packages from container images (and optionally keep build caches)</li>
<li>Extract artefacts from containers</li>
<li>Add metadata(s) and create a repository</li>
<li>(optionally) publish the repository and the artefacts</li>
</ul>
<p>The developer of the derivative applies a customization layer during build, which is an augmentation layer in the same form of <code>cos-toolkit</code> itself.</p>
<h2 id="distribution">Distribution</h2>
<p>The OS delivery mechanism is done via container registries. The developer that wants to provide upgrades for the custom OS will push the resulting container images to the container registry. It will then be used by the installed system to pull upgrades from.</p>
<p><img src="https://docs.google.com/drawings/d/e/2PACX-1vQrTArCYgu-iscf29v1sl1sEn2J81AqBpi9D5xpwGKr9uxR2QywoSqCmsSaJLxRRacoRr0Kq40a7jPF/pub?w=969&amp;h=464" alt=""></p>
<h2 id="upgrade-mechanism">Upgrade mechanism</h2>
<p>There are two different upgrade mechanisms available that can be used from a maintainer perspective: (a) release channels or (b) providing a container image reference ( <code>e.g. my.registry.com/image:tag</code> ) <a href="https://github.com/rancher-sandbox/cOS-toolkit#default-oem">that can be tweaked in the customization phases</a> to achieve the desired effect.</p>
<!-- WIP -->
</div>



    
	
  



          </main>
        </div>
      </div>
      
<footer class="bg-dark py-5 row d-print-none">
  <div class="container-fluid mx-sm-5">
    <div class="row">
      <div class="col-6 col-sm-4 text-xs-center order-sm-2">
        
        
        
      </div>
      <div class="col-6 col-sm-4 text-right text-xs-center order-sm-3">
        
        
        
<ul class="list-inline mb-0">
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Slack" aria-label="Slack">
    <a class="text-white" target="_blank" rel="noopener" href="https://rancher-users.slack.com/messages/cos-toolkit" aria-label="Slack">
      <i class="fab fa-slack"></i>
    </a>
  </li>
  
</ul>

        
        
      </div>
      <div class="col-12 col-sm-4 text-center py-2 order-sm-2">
        <small class="text-white">&copy; 2022 SUSE LLC All Rights Reserved</small>
        <small class="ml-1"><a href="https://www.suse.com/company/legal/" target="_blank" rel="noopener">Privacy Policy</a></small>
	
		
	
      </div>
    </div>
  </div>
</footer>


    </div>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js" integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.min.js" integrity="sha384-+YQ4JLhjyBLPDQt//I+STsc9iw4uQqACwlvpslubQzn4u2UU2UFM80nGisd026JF" crossorigin="anonymous"></script>






 













<script src="https://github.com/rancher-sandbox/cOS-toolkit/js/main.min.3b172c13b62c2bea8b1c9d2599cddc8cf89718a92d792c680871c81ba43d8c85.js" integrity="sha256-OxcsE7YsK&#43;qLHJ0lmc3cjPiXGKkteSxoCHHIG6Q9jIU=" crossorigin="anonymous"></script>



<script src='https://github.com/rancher-sandbox/cOS-toolkit/js/prism.js'></script>



  </body>
</html>
